<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ARTIFACT DETAILS | Scrapyard Terminal</title>

  <!-- SEO Meta Tags -->
  <meta name="description" content="ELRIEL Scrapyard Asset - Explore digital artifacts from the wasteland. Download and rate community-contributed digital assets.">
  <meta name="keywords" content="ELRIEL, Scrapyard, artifact, digital wasteland, cyberpunk, retro, glitch, asset repository">

  <!-- Open Graph / Social Media -->
  <meta property="og:type" content="website">
  <meta property="og:url" content="https://elriel.network/scrapyard/asset">
  <meta property="og:title" content="ARTIFACT DETAILS | Scrapyard Terminal">
  <meta property="og:description" content="Examine detailed information about this digital artifact. Rate, comment, and download.">

  <!-- Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=VT323&family=Share+Tech+Mono&family=IBM+Plex+Mono&display=swap" rel="stylesheet">

  <!-- Stylesheets -->
  <link rel="stylesheet" href="/css/cyberpunk-terminal.css">
  <link rel="stylesheet" href="/css/forum.css">

  <!-- Scripts -->
  <script src="/js/error-logger.js" defer></script>
  <script src="/js/cyberpunk-terminal.js" defer></script>
  <script src="/js/navigation-debug.js" defer></script>
  <script src="/js/mobile-enhancements.js" defer></script>
  <script src="/js/performance-fixes.js" defer></script>
  <link rel="stylesheet" href="/css/responsive-fixes.css">
  <link rel="stylesheet" href="/css/bleedstream-sidebar.css">
  
  <style>
    /* Asset Details Page Specific Styles */
    .asset-details {
      margin-bottom: 2rem;
      position: relative;
    }
    
    .asset-display {
      margin: 1.5rem 0;
      position: relative;
      border: 1px solid var(--border-color);
      padding: 1rem;
      background-color: rgba(0, 0, 0, 0.3);
      max-height: 400px;
      overflow: auto;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .asset-display img {
      max-width: 100%;
      max-height: 350px;
      object-fit: contain;
    }
    
    .asset-info {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1.5rem;
      margin-bottom: 1rem;
    }
    
    .asset-meta {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }
    
    .meta-row {
      display: flex;
      border-bottom: 1px dotted var(--border-color);
      padding-bottom: 0.5rem;
    }
    
    .meta-label {
      flex: 0 0 130px;
      color: var(--text-secondary);
    }
    
    .meta-value {
      flex: 1;
      color: var(--text-primary);
    }
    
    .tag-list {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      margin-top: 0.5rem;
    }
    
    .tag {
      background-color: rgba(0, 255, 0, 0.1);
      border: 1px solid var(--terminal-green);
      padding: 0.25rem 0.5rem;
      font-size: 0.8rem;
      color: var(--terminal-green);
      cursor: pointer;
      transition: all 0.2s ease;
    }
    
    .tag:hover {
      background-color: rgba(0, 255, 0, 0.2);
      transform: translateY(-2px);
    }
    
    /* Rating System */
    .rating-container {
      margin: 1rem 0;
      padding: 1rem;
      background-color: rgba(0, 0, 0, 0.3);
      border: 1px solid var(--border-color);
    }
    
    .rating-stars {
      display: flex;
      gap: 0.5rem;
      margin: 1rem 0;
    }
    
    .star {
      font-size: 1.5rem;
      cursor: pointer;
      color: var(--text-secondary);
      transition: color 0.2s ease, transform 0.2s ease;
    }
    
    .star:hover, .star.active {
      color: var(--terminal-green);
      transform: scale(1.2);
    }
    
    .rating-stats {
      display: flex;
      gap: 1rem;
      font-size: 0.9rem;
      color: var(--text-secondary);
    }
    
    /* Comments Section */
    .comments-section {
      margin-top: 2rem;
    }
    
    .comment {
      margin: 1rem 0;
      padding: 1rem;
      background-color: rgba(0, 0, 0, 0.3);
      border: 1px solid var(--border-color);
      position: relative;
    }
    
    .comment-header {
      display: flex;
      justify-content: space-between;
      margin-bottom: 0.75rem;
      padding-bottom: 0.5rem;
      border-bottom: 1px dotted var(--border-color);
    }
    
    .comment-author {
      color: var(--terminal-green);
      font-weight: bold;
    }
    
    .comment-date {
      font-size: 0.8rem;
      color: var(--text-secondary);
    }
    
    .comment-form {
      margin-top: 1.5rem;
      padding: 1rem;
      background-color: rgba(0, 0, 0, 0.3);
      border: 1px solid var(--border-color);
    }
    
    .comment-form textarea {
      width: 100%;
      min-height: 100px;
      background-color: rgba(0, 0, 0, 0.5);
      border: 1px solid var(--border-color);
      color: var(--text-primary);
      font-family: 'Share Tech Mono', monospace;
      padding: 0.5rem;
      margin-bottom: 1rem;
      resize: vertical;
    }
    
    .asset-actions {
      display: flex;
      gap: 1rem;
      margin: 1.5rem 0;
    }
    
    .asset-actions .button {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    
    .favorite-btn.active {
      background-color: rgba(255, 0, 0, 0.3);
      border-color: rgba(255, 0, 0, 0.8);
    }
    
    .favorite-btn.active:hover {
      background-color: rgba(255, 0, 0, 0.4);
    }
    
    .junker-info {
      padding: 1rem;
      background-color: rgba(0, 0, 0, 0.3);
      border: 1px solid var(--border-color);
      margin-bottom: 1.5rem;
    }
    
    .junker-name {
      color: var(--terminal-green);
      font-size: 1.2rem;
      margin-bottom: 0.5rem;
    }
    
    /* Download button animation */
    @keyframes pulse {
      0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(0, 255, 0, 0.4); }
      70% { transform: scale(1.05); box-shadow: 0 0 0 10px rgba(0, 255, 0, 0); }
      100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(0, 255, 0, 0); }
    }
    
    .download-btn {
      animation: pulse 2s infinite;
      background-color: rgba(0, 0, 0, 0.5);
      border: 1px solid var(--terminal-green);
      color: var(--terminal-green);
    }
  </style>
</head>
<body class="terminal">
  <!-- Screen Effects -->
  <div class="noise-overlay"></div>
  <div class="scan-lines"></div>
  <div class="crt-effect"></div>

  <!-- Main Container -->
  <div class="container">
    <header class="main-header">
      <div class="logo">
        <h1 class="glitch" data-text="ELRIEL">ELRIEL</h1>
        <div class="logo-subtitle">DIGITAL WASTELAND v1.3.7</div>
      </div>
      <div class="user-panel">
        <div id="user-status">
          <!-- User status will be injected here -->
        </div>
      </div>
    </header>

    <div class="content-wrapper">
      <button class="mobile-nav-toggle" id="mobile-nav-toggle">TOGGLE NAVIGATION</button>
      <nav class="sidebar" id="main-sidebar">
        <div class="nav-section">
          <h3 class="nav-title">MAIN SYSTEMS</h3>
          <ul class="nav-links">
            <li><a href="/">TERMINAL</a></li>
            <li><a href="/feed/bleedstream">BLEEDSTREAM</a></li>
            <li><a href="/glyph/crucible">GLYPH CRUCIBLE</a></li>
            <li><a href="/whisper/board">WHISPERBOARD</a></li>
            <li><a href="/scrapyard" class="active">SCRAPYARD</a></li>
          </ul>
        </div>
        <div class="nav-section">
          <h3 class="nav-title">PROFILE</h3>
          <ul class="nav-links">
            <li><a href="/profile">DASHBOARD</a></li>
            <li><a href="/profile/edit">EDIT PROFILE</a></li>
            <li><a href="/feed/new">CREATE POST</a></li>
          </ul>
        </div>
        <div class="nav-section">
          <h3 class="nav-title">SYSTEM</h3>
          <ul class="nav-links">
            <li><a href="/about">ABOUT</a></li>
            <li><a href="#" id="toggle-glitch">TOGGLE GLITCH</a></li>
          </ul>
        </div>
      </nav>

      <main class="main-content">
        <!-- System Log Sidebar -->
        <aside class="system-log-sidebar">
          <div class="panel-header">
            <h2>ARTIFACT SCAN</h2>
            <div class="status-indicator">LIVE</div>
          </div>
          <div class="panel-content" id="system-log">
            <div class="log-entry">
              <span class="log-time">06:52:32</span>
              <span class="log-text">Initializing artifact scan</span>
            </div>
            <div class="log-entry">
              <span class="log-time">06:52:33</span>
              <span class="log-text">Reading metadata...</span>
            </div>
            <div class="log-entry">
              <span class="log-time">06:52:34</span>
              <span class="log-text">Artifact signature verified</span>
            </div>
            <div class="log-entry">
              <span class="log-time">06:52:35</span>
              <span class="log-text">Decrypting content layers</span>
            </div>
            <div class="log-entry">
              <span class="log-time">06:52:36</span>
              <span class="log-text">Analyzing component structures</span>
            </div>
            <div class="log-entry">
              <span class="log-time">06:52:37</span>
              <span class="log-text">Reconstruction complete</span>
            </div>
          </div>
        </aside>

        <!-- Asset Detail Panel -->
        <section class="panel asset-detail-panel">
          <div class="scanner-line"></div>
          <div class="panel-header">
            <h2>ARTIFACT <span id="asset-id">#000</span></h2>
            <div class="status-indicator alert">ACTIVE</div>
          </div>
          <div class="panel-content">
            <div id="asset-details">
              <!-- Asset details will be injected here -->
              <div class="loading-indicator">ANALYZING ARTIFACT DATA</div>
            </div>
          </div>
        </section>

        <!-- Comments Panel -->
        <section class="panel comments-panel">
          <div class="scanner-line"></div>
          <div class="panel-header">
            <h2>ANALYSES</h2>
            <div class="status-indicator">ARCHIVE</div>
          </div>
          <div class="panel-content">
            <div id="asset-comments">
              <!-- Comments will be injected here -->
              <div class="loading-indicator">RETRIEVING ANALYSES</div>
            </div>
          </div>
        </section>
      </main>
    </div>

    <footer class="main-footer">
      <div class="footer-text">ELRIEL NETWORK // ESTABLISHED 2025 // ALL RIGHTS SURRENDERED</div>
      <div class="footer-glyphs">
        <span class="glyph" data-symbol="command">⌘</span>
        <span class="glyph" data-symbol="star">⍟</span>
        <span class="glyph" data-symbol="node">⎔</span>
      </div>
    </footer>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', function() {
      console.log('[ARTIFACT] Initializing artifact interface...');

      // Initialize all components
      initBootstrapSequence();
      initAssetData();
      initScrapLog();

      // Add event listeners
      addEventListeners();

      // Dispatch system ready event
      setTimeout(() => {
        console.log('[ARTIFACT] All systems operational.');
        document.dispatchEvent(new CustomEvent('assetReady'));
      }, 1000);
    });

    /**
     * Bootstrap sequence - initial loading animation
     */
    function initBootstrapSequence() {
      // Create a visual effect when entering the asset view
      const bootstrapEffect = () => {
        document.body.classList.add('glitch-active');
        setTimeout(() => {
          document.body.classList.remove('glitch-active');
        }, 500);
      };

      // Add delayed bootstrap visual effect
      setTimeout(bootstrapEffect, 300);
      setTimeout(bootstrapEffect, 1200);
    }

    /**
     * Initialize asset data and user information
     */
    function initAssetData() {
      // Parse injected data with error handling
      let data = {};
      try {
        // Inject data from server
        data = __DATA__;
        console.log("[ARTIFACT] Data loaded successfully:", {
          assetId: data.asset ? data.asset.id : 'unknown',
          commentCount: data.comments ? data.comments.length : 0,
          hasUser: !!data.user
        });
      } catch (err) {
        console.error("[ARTIFACT] Error parsing injected data:", err);
        data = { asset: null, comments: [] };
      }

      // Store for later use
      window.assetData = data;

      // Update user status in header
      const userStatusEl = document.getElementById('user-status');
      if (data.user) {
        userStatusEl.innerHTML = `
          <div class="logged-in">
            <span class="username">${data.user.username}</span>
            <div class="user-links">
              <a href="/profile" class="button">PROFILE</a>
              <a href="/auth/logout" class="button">LOGOUT</a>
            </div>
          </div>
        `;
      } else {
        userStatusEl.innerHTML = `
          <div class="logged-out">
            <a href="/auth/login" class="button login-btn">LOGIN</a>
            <a href="/auth/register" class="button register-btn">REGISTER</a>
          </div>
        `;
      }

      // Update asset ID in header
      const asset = data.asset;
      if (asset) {
        const assetIdPadded = asset.id.toString().padStart(3, '0');
        document.getElementById('asset-id').textContent = `#${assetIdPadded}`;
        document.title = `${asset.title} | Artifact #${assetIdPadded}`;
      }

      // Render asset details
      renderAssetDetails(data);

      // Render comments
      renderComments(data);
    }

    /**
     * Render asset details
     */
    function renderAssetDetails(data) {
      const assetDetailsEl = document.getElementById('asset-details');
      const asset = data.asset;

      if (!asset) {
        assetDetailsEl.innerHTML = `
          <div class="empty-state">
            <div class="empty-icon">⨯</div>
            <div class="empty-message">ARTIFACT NOT FOUND</div>
            <div class="empty-subtitle">The requested artifact does not exist or has been corrupted.</div>
            <a href="/scrapyard" class="button hover-glow">RETURN TO SCRAPYARD</a>
          </div>
        `;
        return;
      }

      // Format dates
      const createdDate = new Date(asset.created_at).toLocaleDateString('en-US', {
        year: 'numeric',
        month: 'short',
        day: 'numeric'
      });

      // Generate SVG artifact icon
      const artifactIdPadded = asset.id.toString().padStart(3, '0');
      
      // Build tags HTML
      let tagsHtml = '';
      if (data.assetTags && data.assetTags.length > 0) {
        tagsHtml = `
          <div class="tag-list">
            ${data.assetTags.map(tag => `<a href="/scrapyard/tag/${tag.id}" class="tag">${tag.name}</a>`).join('')}
          </div>
        `;
      } else {
        tagsHtml = '<em>No tags</em>';
      }

      // Determine if we should show image preview
      const fileExt = (asset.file_path || '').split('.').pop().toLowerCase();
      const isImage = ['jpg', 'jpeg', 'png', 'gif', 'webp', 'svg'].includes(fileExt);
      
      // Create asset display HTML
      let assetDisplayHtml = '';
      
      if (isImage) {
        assetDisplayHtml = `
          <div class="asset-display">
            <img src="${asset.file_path}" alt="${asset.title}" />
          </div>
        `;
      } else if (asset.thumbnail_path) {
        assetDisplayHtml = `
          <div class="asset-display">
            <img src="${asset.thumbnail_path}" alt="${asset.title} (thumbnail)" />
          </div>
        `;
      }

      // Format ratings
      const ratingHtml = generateRatingHtml(asset, data.userRating);

      // Compile the asset details HTML
      assetDetailsEl.innerHTML = `
        <h1 class="asset-title">${asset.title}</h1>
        
        ${assetDisplayHtml}
        
        <div class="junker-info">
          <div class="junker-name">JUNKER: ${asset.junker_name}</div>
          <div class="username">USER: ${asset.username}</div>
        </div>
        
        <div class="asset-info">
          <div class="asset-meta">
            <div class="meta-row">
              <span class="meta-label">CATEGORY:</span>
              <span class="meta-value">
                <a href="/scrapyard/category/${asset.category_id}">${asset.category_display_name || asset.category_name}</a>
              </span>
            </div>
            <div class="meta-row">
              <span class="meta-label">TYPE:</span>
              <span class="meta-value">${asset.asset_type}</span>
            </div>
            <div class="meta-row">
              <span class="meta-label">DISCOVERED:</span>
              <span class="meta-value">${createdDate}</span>
            </div>
            <div class="meta-row">
              <span class="meta-label">DOWNLOADS:</span>
              <span class="meta-value">${asset.download_count || 0}</span>
            </div>
            <div class="meta-row">
              <span class="meta-label">FAVORITES:</span>
              <span class="meta-value">${asset.likes_count || 0}</span>
            </div>
          </div>
          
          <div class="asset-description">
            <h3>DESCRIPTION</h3>
            <p>${asset.description}</p>
            
            <h3>TAGS</h3>
            ${tagsHtml}
          </div>
        </div>
        
        ${ratingHtml}
        
        <div class="asset-actions">
          <a href="${asset.file_path}" class="button download-btn hover-glow" download>
            <span class="icon">⬇</span> DOWNLOAD ARTIFACT
          </a>
          
          ${data.user ? `
            <button class="button favorite-btn ${data.isFavorited ? 'active' : ''}" id="favorite-btn">
              <span class="icon">♥</span> ${data.isFavorited ? 'REMOVE FAVORITE' : 'ADD TO FAVORITES'}
            </button>
          ` : ''}
          
          <a href="/scrapyard" class="button hover-glow">
            <span class="icon">⬅</span> BACK TO SCRAPYARD
          </a>
        </div>
      `;
    }

    /**
     * Generate rating HTML section
     */
    function generateRatingHtml(asset, userRating) {
      // Format current rating display
      const ratingDisplay = asset.rating ? 
        parseFloat(asset.rating).toFixed(1) : 
        'Not yet rated';
      
      // Don't show rating form for non-logged in users
      if (!window.assetData.user) {
        return `
          <div class="rating-container">
            <h3>ARTIFACT RATING</h3>
            <div class="rating-stats">
              <div>Average Rating: <strong>${ratingDisplay}</strong></div>
              <div>Total Ratings: <strong>${asset.rating_count || 0}</strong></div>
            </div>
            <div class="login-prompt">
              <a href="/auth/login?redirect=/scrapyard/asset/${asset.id}" class="button hover-glow">LOGIN TO RATE</a>
            </div>
          </div>
        `;
      }
      
      // Render rating form for logged in users
      return `
        <div class="rating-container">
          <h3>ARTIFACT RATING</h3>
          <div class="rating-stats">
            <div>Average Rating: <strong>${ratingDisplay}</strong></div>
            <div>Total Ratings: <strong>${asset.rating_count || 0}</strong></div>
          </div>
          <div class="rating-form">
            <p>Rate this artifact:</p>
            <div class="rating-stars" id="rating-stars">
              <span class="star ${userRating >= 1 ? 'active' : ''}" data-rating="1">★</span>
              <span class="star ${userRating >= 2 ? 'active' : ''}" data-rating="2">★</span>
              <span class="star ${userRating >= 3 ? 'active' : ''}" data-rating="3">★</span>
              <span class="star ${userRating >= 4 ? 'active' : ''}" data-rating="4">★</span>
              <span class="star ${userRating >= 5 ? 'active' : ''}" data-rating="5">★</span>
            </div>
          </div>
        </div>
      `;
    }

    /**
     * Render comments section
     */
    function renderComments(data) {
      const commentsEl = document.getElementById('asset-comments');
      const asset = data.asset;
      const comments = data.comments || [];

      if (!asset) {
        commentsEl.innerHTML = '';
        return;
      }

      let commentsHtml = '';
      
      if (comments.length > 0) {
        commentsHtml = comments.map(comment => {
          const commentDate = new Date(comment.created_at).toLocaleDateString('en-US', {
            year: 'numeric',
            month: 'short',
            day: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
          });
          
          return `
            <div class="comment">
              <div class="comment-header">
                <span class="comment-author">${comment.username}</span>
                <span class="comment-date">${commentDate}</span>
              </div>
              <div class="comment-content">${comment.content}</div>
            </div>
          `;
        }).join('');
      } else {
        commentsHtml = `
          <div class="empty-state">
            <div class="empty-message">NO ANALYSES FOUND</div>
            <div class="empty-subtitle">Be the first to analyze this artifact.</div>
          </div>
        `;
      }

      // Add comment form if user is logged in
      const commentFormHtml = data.user ? `
        <div class="comment-form">
          <h3>ADD ANALYSIS</h3>
          <form id="comment-form">
            <textarea id="comment-content" placeholder="Enter your analysis of this artifact..."></textarea>
            <button type="submit" class="button hover-glow">SUBMIT ANALYSIS</button>
          </form>
        </div>
      ` : `
        <div class="login-prompt">
          <a href="/auth/login?redirect=/scrapyard/asset/${asset.id}" class="button hover-glow">LOGIN TO ANALYZE</a>
        </div>
      `;

      commentsEl.innerHTML = commentsHtml + commentFormHtml;
    }

    /**
     * Initialize scrap log with dynamic updates
     */
    function initScrapLog() {
      const systemLog = document.getElementById('system-log');
      if (!systemLog) return;

      // Possible log messages for artifact view
      const possibleLogs = [
        'Analyzing sector %d of artifact',
        'Component structure verified',
        'Found anomaly in metadata block',
        'Digital signature confirmed',
        'Running pattern recognition level %d'
      ];

      // Format log message with random values
      const formatLogMessage = (message) => {
        return message.replace('%d', Math.floor(Math.random() * 100));
      };

      // Add new log periodically
      let logInterval = setInterval(() => {
        // Only add logs if the page is visible
        if (document.hidden) return;

        if (Math.random() < 0.3) { // 30% chance to add a new log
          const currentTime = new Date();
          const timeString = currentTime.toLocaleTimeString('en-US', {
            hour12: false,
            hour: '2-digit',
            minute: '2-digit',
            second: '2-digit'
          });

          const logMessage = possibleLogs[Math.floor(Math.random() * possibleLogs.length)];
          const formattedMessage = formatLogMessage(logMessage);

          const logEntry = document.createElement('div');
          logEntry.className = 'log-entry';
          logEntry.innerHTML = `
            <span class="log-time">${timeString}</span>
            <span class="log-text">${formattedMessage}</span>
          `;

          // Add to top of log
          systemLog.insertBefore(logEntry, systemLog.firstChild);

          // Remove old logs if too many
          while (systemLog.children.length > 10) {
            systemLog.removeChild(systemLog.lastChild);
          }
        }
      }, 6000);

      // Clean up interval when page is hidden
      document.addEventListener('visibilitychange', () => {
        if (document.hidden && logInterval) {
          clearInterval(logInterval);
          logInterval = null;
        } else if (!document.hidden && !logInterval) {
          logInterval = setInterval(addRandomLog, 6000);
        }
      });

      // Clean up on page unload
      window.addEventListener('beforeunload', () => {
        if (logInterval) {
          clearInterval(logInterval);
          logInterval = null;
        }
      });
    }

    /**
     * Add event listeners for interactive elements
     */
    function addEventListeners() {
      // Toggle glitch effects
      const glitchToggle = document.getElementById('toggle-glitch');
      if (glitchToggle) {
        glitchToggle.addEventListener('click', function(e) {
          e.preventDefault();
          document.body.classList.toggle('glitch-active');
          
          // Store preference in localStorage
          localStorage.setItem('glitch-active', document.body.classList.contains('glitch-active') ? 'true' : 'false');
        });
      }

      // Check if glitch effects were previously enabled
      const glitchActive = localStorage.getItem('glitch-active');
      if (glitchActive === 'true') {
        document.body.classList.add('glitch-active');
      }

      // Mobile navigation toggle
      const mobileNavToggle = document.getElementById('mobile-nav-toggle');
      const sidebar = document.getElementById('main-sidebar');

      if (mobileNavToggle && sidebar) {
        mobileNavToggle.addEventListener('click', function() {
          sidebar.classList.toggle('active');
          this.textContent = sidebar.classList.contains('active') ? 'HIDE NAVIGATION' : 'SHOW NAVIGATION';
          
          // Store sidebar state in localStorage
          localStorage.setItem('sidebar-active', sidebar.classList.contains('active') ? 'true' : 'false');
        });

        // Set initial state on page load
        const sidebarActive = localStorage.getItem('sidebar-active');
        if (sidebarActive === 'true') {
          sidebar.classList.add('active');
          mobileNavToggle.textContent = 'HIDE NAVIGATION';
        }
      }

      // Rating stars
      const ratingStars = document.getElementById('rating-stars');
      if (ratingStars) {
        const stars = ratingStars.querySelectorAll('.star');
        
        stars.forEach(star => {
          star.addEventListener('click', function() {
            const rating = parseInt(this.getAttribute('data-rating'), 10);
            
            // Submit rating
            submitRating(rating);
          });
        });
      }

      // Favorite button
      const favoriteBtn = document.getElementById('favorite-btn');
      if (favoriteBtn) {
        favoriteBtn.addEventListener('click', function() {
          toggleFavorite();
        });
      }

      // Comment form
      const commentForm = document.getElementById('comment-form');
      if (commentForm) {
        commentForm.addEventListener('submit', function(e) {
          e.preventDefault();
          submitComment();
        });
      }
    }

    /**
     * Submit rating
     */
    function submitRating(rating) {
      const assetId = window.assetData.asset.id;
      
      // Add visual feedback while submitting
      const stars = document.querySelectorAll('.star');
      stars.forEach(star => {
        const starRating = parseInt(star.getAttribute('data-rating'), 10);
        if (starRating <= rating) {
          star.classList.add('active');
        } else {
          star.classList.remove('active');
        }
      });
      
      // Submit to server
      fetch(`/scrapyard/asset/${assetId}/rate`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({ rating })
      })
      .then(res => res.json())
      .then(data => {
        if (data.success) {
          console.log('Rating submitted successfully:', data);
          
          // Update the asset rating in the data
          window.assetData.asset.rating = data.newRating;
          window.assetData.asset.rating_count = data.ratingCount;
          window.assetData.userRating = rating;
          
          // Add log entry
          addScrapLog(`Rating updated to ${rating}/5 stars`);
          
          // Refresh the rating stats display
          const ratingStats = document.querySelector('.rating-stats');
          if (ratingStats) {
            ratingStats.innerHTML = `
              <div>Average Rating: <strong>${parseFloat(data.newRating).toFixed(1)}</strong></div>
              <div>Total Ratings: <strong>${data.ratingCount}</strong></div>
            `;
          }
        } else {
          console.error('Error submitting rating:', data);
          alert('Error submitting rating: ' + (data.message || 'Unknown error'));
        }
      })
      .catch(err => {
        console.error('Error submitting rating:', err);
        alert('Network error when submitting rating');
      });
    }

    /**
     * Toggle favorite status
     */
    function toggleFavorite() {
      const assetId = window.assetData.asset.id;
      const favoriteBtn = document.getElementById('favorite-btn');
      
      // Add visual feedback while submitting
      favoriteBtn.disabled = true;
      
      // Submit to server
      fetch(`/scrapyard/asset/${assetId}/favorite`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        }
      })
      .then(res => res.json())
      .then(data => {
        if (data.success) {
          console.log('Favorite status toggled:', data);
          
          // Update the favorite status
          window.assetData.isFavorited = data.isFavorited;
          
          // Update button
          favoriteBtn.classList.toggle('active', data.isFavorited);
          favoriteBtn.innerHTML = `
            <span class="icon">♥</span> ${data.isFavorited ? 'REMOVE FAVORITE' : 'ADD TO FAVORITE'}
          `;
          
          // Update likes count
          const likesCountEl = document.querySelector('.meta-value:nth-of-type(5)');
          if (likesCountEl) {
            const currentCount = parseInt(likesCountEl.textContent, 10) || 0;
            const newCount = data.isFavorited ? currentCount + 1 : Math.max(0, currentCount - 1);
            likesCountEl.textContent = newCount;
            window.assetData.asset.likes_count = newCount;
          }
          
          // Add log entry
          addScrapLog(data.isFavorited ? 'Artifact added to favorites' : 'Artifact removed from favorites');
        } else {
          console.error('Error toggling favorite:', data);
          alert('Error toggling favorite: ' + (data.message || 'Unknown error'));
        }
        
        favoriteBtn.disabled = false;
      })
      .catch(err => {
        console.error('Error toggling favorite:', err);
        alert('Network error when toggling favorite');
        favoriteBtn.disabled = false;
      });
    }

    /**
     * Submit comment
     */
    function submitComment() {
      const assetId = window.assetData.asset.id;
      const contentEl = document.getElementById('comment-content');
      const content = contentEl.value.trim();
      
      if (!content) {
        alert('Please enter a comment');
        return;
      }
      
      // Disable the form while submitting
      const submitBtn = document.querySelector('#comment-form button');
      submitBtn.disabled = true;
      
      // Submit to server
      fetch(`/scrapyard/asset/${assetId}/comment`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({ content })
      })
      .then(res => res.json())
      .then(data => {
        if (data.success) {
          console.log('Comment submitted successfully:', data);
          
          // Clear the form
          contentEl.value = '';
          
          // Reload the page to show the new comment
          window.location.reload();
        } else {
          console.error('Error submitting comment:', data);
          alert('Error submitting comment: ' + (data.message || 'Unknown error'));
          submitBtn.disabled = false;
        }
      })
      .catch(err => {
        console.error('Error submitting comment:', err);
        alert('Network error when submitting comment');
        submitBtn.disabled = false;
      });
    }

    /**
     * Add a message to the scrap log
     */
    function addScrapLog(message) {
      const systemLog = document.getElementById('system-log');
      if (!systemLog) return;

      const currentTime = new Date();
      const timeString = currentTime.toLocaleTimeString('en-US', {
        hour12: false,
        hour: '2-digit',
        minute: '2-digit',
        second: '2-digit'
      });

      const logEntry = document.createElement('div');
      logEntry.className = 'log-entry';
      logEntry.innerHTML = `
        <span class="log-time">${timeString}</span>
        <span class="log-text">${message}</span>
      `;

      // Add with highlight effect
      logEntry.classList.add('highlight');
      setTimeout(() => {
        logEntry.classList.remove('highlight');
      }, 2000);

      // Add to top of log
      systemLog.insertBefore(logEntry, systemLog.firstChild);

      // Remove old logs if too many
      if (systemLog.children.length > 15) {
        systemLog.removeChild(systemLog.lastChild);
      }
    }
  </script>
</body>
</html>