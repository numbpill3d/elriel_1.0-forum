<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>DEPOSIT ARTIFACT | Scrapyard Terminal</title>

  <!-- SEO Meta Tags -->
  <meta name="description" content="ELRIEL Scrapyard - Upload and share your digital artifacts with the community. Add your own art, PNGs, and web development assets.">
  <meta name="keywords" content="ELRIEL, Scrapyard, upload, digital assets, cyberpunk, retro, glitch, art repository">

  <!-- Open Graph / Social Media -->
  <meta property="og:type" content="website">
  <meta property="og:url" content="https://elriel.network/scrapyard/upload">
  <meta property="og:title" content="DEPOSIT ARTIFACT | Scrapyard Terminal">
  <meta property="og:description" content="Upload and share your digital artifacts with the community.">

  <!-- Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=VT323&family=Share+Tech+Mono&family=IBM+Plex+Mono&display=swap" rel="stylesheet">

  <!-- Stylesheets -->
  <link rel="stylesheet" href="/css/cyberpunk-terminal.css">
  <link rel="stylesheet" href="/css/forum.css">
  <link rel="stylesheet" href="/css/scrapyard.css">

  <!-- Scripts -->
  <script src="/js/error-logger.js" defer></script>
  <script src="/js/cyberpunk-terminal.js" defer></script>
  <script src="/js/navigation-debug.js" defer></script>
  <script src="/js/mobile-enhancements.js" defer></script>
  <script src="/js/performance-fixes.js" defer></script>
  <link rel="stylesheet" href="/css/responsive-fixes.css">
  <link rel="stylesheet" href="/css/bleedstream-sidebar.css">
</head>
<body class="terminal">
  <!-- Screen Effects -->
  <div class="noise-overlay"></div>
  <div class="scan-lines"></div>
  <div class="crt-effect"></div>

  <!-- Main Container -->
  <div class="container">
    <header class="main-header">
      <div class="logo">
        <h1 class="glitch" data-text="ELRIEL">ELRIEL</h1>
        <div class="logo-subtitle">DIGITAL WASTELAND v1.3.7</div>
      </div>
      <div class="user-panel">
        <div id="user-status">
          <!-- User status will be injected here -->
        </div>
      </div>
    </header>

    <div class="content-wrapper">
      <button class="mobile-nav-toggle" id="mobile-nav-toggle">TOGGLE NAVIGATION</button>
      <nav class="sidebar" id="main-sidebar">
        <div class="nav-section">
          <h3 class="nav-title">MAIN SYSTEMS</h3>
          <ul class="nav-links">
            <li><a href="/">TERMINAL</a></li>
            <li><a href="/feed/bleedstream">BLEEDSTREAM</a></li>
            <li><a href="/glyph/crucible">GLYPH CRUCIBLE</a></li>
            <li><a href="/whisper/board">WHISPERBOARD</a></li>
            <li><a href="/scrapyard" class="active">SCRAPYARD</a></li>
          </ul>
        </div>
        <div class="nav-section">
          <h3 class="nav-title">PROFILE</h3>
          <ul class="nav-links">
            <li><a href="/profile">DASHBOARD</a></li>
            <li><a href="/profile/edit">EDIT PROFILE</a></li>
            <li><a href="/feed/new">CREATE POST</a></li>
          </ul>
        </div>
        <div class="nav-section">
          <h3 class="nav-title">SYSTEM</h3>
          <ul class="nav-links">
            <li><a href="/about">ABOUT</a></li>
            <li><a href="#" id="toggle-glitch">TOGGLE GLITCH</a></li>
          </ul>
        </div>
      </nav>

      <main class="main-content">
        <!-- System Log Sidebar -->
        <aside class="system-log-sidebar">
          <div class="panel-header">
            <h2>UPLOAD LOG</h2>
            <div class="status-indicator">LIVE</div>
          </div>
          <div class="panel-content" id="system-log">
            <div class="log-entry">
              <span class="log-time">06:52:32</span>
              <span class="log-text">Initializing upload interface</span>
            </div>
            <div class="log-entry">
              <span class="log-time">06:52:33</span>
              <span class="log-text">Scanning for asset categories</span>
            </div>
            <div class="log-entry">
              <span class="log-time">06:52:34</span>
              <span class="log-text">Available storage: quantum-flux</span>
            </div>
            <div class="log-entry">
              <span class="log-time">06:52:35</span>
              <span class="log-text">Ready to process artifacts</span>
            </div>
          </div>
        </aside>

        <!-- Upload Panel -->
        <section class="panel upload-panel">
          <div class="scanner-line"></div>
          <div class="panel-header">
            <h2>DEPOSIT ARTIFACT</h2>
            <div class="status-indicator alert">ACTIVE</div>
          </div>
          <div class="panel-content">
            <div class="upload-intro">
              <p>JUNKER <span id="junker-name">UNKNOWN</span>: You are about to contribute a digital artifact to the Scrapyard. Select your file, add descriptive details, and categorize appropriately to help others discover your content.</p>
            </div>

            <div class="upload-form" id="upload-form-container">
              <!-- Form will be generated here, either S3 or local -->
            </div>
          </div>
        </section>

        <!-- Asset Categories Reference -->
        <section class="panel reference-panel">
          <div class="scanner-line"></div>
          <div class="panel-header">
            <h2>CLASSIFICATION GUIDE</h2>
            <div class="status-indicator">REFERENCE</div>
          </div>
          <div class="panel-content">
            <div id="categories-reference">
              <!-- Categories and tags will be listed here -->
              <div class="loading-indicator">LOADING ARTIFACT TAXONOMY</div>
            </div>
          </div>
        </section>
      </main>
    </div>

    <footer class="main-footer">
      <div class="footer-text">ELRIEL NETWORK // ESTABLISHED 2025 // ALL RIGHTS SURRENDERED</div>
      <div class="footer-glyphs">
        <span class="glyph" data-symbol="command">⌘</span>
        <span class="glyph" data-symbol="star">⍟</span>
        <span class="glyph" data-symbol="node">⎔</span>
      </div>
    </footer>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', function() {
      console.log('[UPLOAD] Initializing upload interface...');

      // Initialize all components
      initBootstrapSequence();
      initUploadData();
      initScrapLog();

      // Add event listeners
      addEventListeners();

      // Dispatch system ready event
      setTimeout(() => {
        console.log('[UPLOAD] All systems operational.');
        document.dispatchEvent(new CustomEvent('uploadReady'));
      }, 1000);
    });

    /**
     * Bootstrap sequence - initial loading animation
     */
    function initBootstrapSequence() {
      // Create a visual effect when entering the asset view
      const bootstrapEffect = () => {
        document.body.classList.add('glitch-active');
        setTimeout(() => {
          document.body.classList.remove('glitch-active');
        }, 500);
      };

      // Add delayed bootstrap visual effect
      setTimeout(bootstrapEffect, 300);
      setTimeout(bootstrapEffect, 1200);
    }

    /**
     * Initialize upload data
     */
    function initUploadData() {
      // Parse injected data with error handling
      let data = {};
      try {
        // Inject data from server
        data = __DATA__;
        console.log("[UPLOAD] Data loaded successfully:", {
          categoriesCount: data.categories ? data.categories.length : 0,
          tagsCount: data.tags ? data.tags.length : 0,
          hasUser: !!data.user
        });
      } catch (err) {
        console.error("[UPLOAD] Error parsing injected data:", err);
        data = { categories: [], tags: [] };
      }

      // Store for later use
      window.uploadData = data;

      // Update user status in header
      const userStatusEl = document.getElementById('user-status');
      if (data.user) {
        userStatusEl.innerHTML = `
          <div class="logged-in">
            <span class="username">${data.user.username}</span>
            <div class="user-links">
              <a href="/profile" class="button">PROFILE</a>
              <a href="/auth/logout" class="button">LOGOUT</a>
            </div>
          </div>
        `;
      } else {
        userStatusEl.innerHTML = `
          <div class="logged-out">
            <a href="/auth/login" class="button login-btn">LOGIN</a>
            <a href="/auth/register" class="button register-btn">REGISTER</a>
          </div>
        `;
      }

      // Update junker name
      if (data.junker) {
        document.getElementById('junker-name').textContent = data.junker.junker_name;
      }

      // Render upload form
      renderUploadForm(data);

      // Render categories reference
      renderCategoriesReference(data);
    }

    /**
     * Render the appropriate upload form based on S3 configuration
     */
    function renderUploadForm(data) {
      const formContainer = document.getElementById('upload-form-container');
      const s3Configured = data.s3Configured;

      if (s3Configured) {
        // Render S3 direct upload form
        formContainer.innerHTML = `
          <form id="s3-upload-form" class="upload-form">
            <div class="form-grid">
              <div>
                <div class="form-group">
                  <label for="title">ARTIFACT TITLE *</label>
                  <input type="text" id="title" name="title" required>
                </div>
                
                <div class="form-group">
                  <label for="category_id">CATEGORY *</label>
                  <select id="category_id" name="category_id" required>
                    <option value="">-- Select Category --</option>
                    ${data.categories.map(cat => `<option value="${cat.id}">${cat.display_name || cat.name}</option>`).join('')}
                  </select>
                </div>
                
                <div class="form-group">
                  <label for="asset_type">ASSET TYPE *</label>
                  <select id="asset_type" name="asset_type" required>
                    <option value="">-- Select Type --</option>
                    <option value="image">IMAGE</option>
                    <option value="font">FONT</option>
                    <option value="template">TEMPLATE</option>
                    <option value="code">CODE SNIPPET</option>
                    <option value="widget">WIDGET</option>
                    <option value="other">OTHER</option>
                  </select>
                </div>
                
                <div class="form-group">
                  <label for="is_free">AVAILABILITY</label>
                  <select id="is_free" name="is_free">
                    <option value="true">FREE</option>
                    <option value="false">RESTRICTED</option>
                  </select>
                </div>
              </div>
              
              <div>
                <div class="form-group">
                  <label for="description">DESCRIPTION *</label>
                  <textarea id="description" name="description" required></textarea>
                </div>
                
                <div class="form-group">
                  <label for="tags">TAGS (COMMA SEPARATED)</label>
                  <input type="text" id="tags" name="tags" placeholder="tag1, tag2, tag3">
                </div>
                
                <div class="form-group tags-container">
                  <div class="tag-list" id="selected-tags"></div>
                  <div class="tag-suggestions" id="tag-suggestions"></div>
                </div>
              </div>
            </div>
            
            <div class="form-group">
              <label>PRIMARY ARTIFACT FILE *</label>
              <div class="drag-area" id="asset-upload-area">
                <div class="icon">⬆</div>
                <p>Drag & drop your file here or click to select</p>
                <input type="file" id="asset-file" hidden>
              </div>
              <div class="preview-container" id="asset-preview">
                <p>No file selected</p>
              </div>
              <input type="hidden" id="assetKey" name="assetKey">
              <input type="hidden" id="assetUrl" name="assetUrl">
            </div>
            
            <div class="form-group">
              <label>THUMBNAIL IMAGE (OPTIONAL)</label>
              <div class="drag-area" id="thumbnail-upload-area">
                <div class="icon">⬆</div>
                <p>Drag & drop thumbnail here or click to select</p>
                <input type="file" id="thumbnail-file" hidden>
              </div>
              <div class="preview-container" id="thumbnail-preview">
                <p>No thumbnail selected</p>
              </div>
              <input type="hidden" id="thumbnailKey" name="thumbnailKey">
              <input type="hidden" id="thumbnailUrl" name="thumbnailUrl">
            </div>
            
            <div class="form-group">
              <button type="submit" class="button hover-glow">DEPOSIT ARTIFACT</button>
              <a href="/scrapyard" class="button">CANCEL</a>
            </div>
            
            <div id="upload-status" class="upload-status"></div>
          </form>
        `;
        
        // Initialize S3 upload
        initS3Uploads();
      } else {
        // Render local upload form
        formContainer.innerHTML = `
          <form id="local-upload-form" class="upload-form" action="/scrapyard/upload" method="post" enctype="multipart/form-data">
            <div class="form-grid">
              <div>
                <div class="form-group">
                  <label for="title">ARTIFACT TITLE *</label>
                  <input type="text" id="title" name="title" required>
                </div>
                
                <div class="form-group">
                  <label for="category_id">CATEGORY *</label>
                  <select id="category_id" name="category_id" required>
                    <option value="">-- Select Category --</option>
                    ${data.categories.map(cat => `<option value="${cat.id}">${cat.display_name || cat.name}</option>`).join('')}
                  </select>
                </div>
                
                <div class="form-group">
                  <label for="asset_type">ASSET TYPE *</label>
                  <select id="asset_type" name="asset_type" required>
                    <option value="">-- Select Type --</option>
                    <option value="image">IMAGE</option>
                    <option value="font">FONT</option>
                    <option value="template">TEMPLATE</option>
                    <option value="code">CODE SNIPPET</option>
                    <option value="widget">WIDGET</option>
                    <option value="other">OTHER</option>
                  </select>
                </div>
                
                <div class="form-group">
                  <label for="is_free">AVAILABILITY</label>
                  <select id="is_free" name="is_free">
                    <option value="true">FREE</option>
                    <option value="false">RESTRICTED</option>
                  </select>
                </div>
              </div>
              
              <div>
                <div class="form-group">
                  <label for="description">DESCRIPTION *</label>
                  <textarea id="description" name="description" required></textarea>
                </div>
                
                <div class="form-group">
                  <label for="tags">TAGS (COMMA SEPARATED)</label>
                  <input type="text" id="tags" name="tags" placeholder="tag1, tag2, tag3">
                </div>
                
                <div class="form-group tags-container">
                  <div class="tag-list" id="selected-tags"></div>
                  <div class="tag-suggestions" id="tag-suggestions"></div>
                </div>
              </div>
            </div>
            
            <div class="form-group">
              <label for="asset">PRIMARY ARTIFACT FILE *</label>
              <input type="file" id="asset" name="asset" required>
              <div class="preview-container" id="asset-preview">
                <p>No file selected</p>
              </div>
            </div>
            
            <div class="form-group">
              <label for="thumbnail">THUMBNAIL IMAGE (OPTIONAL)</label>
              <input type="file" id="thumbnail" name="thumbnail">
              <div class="preview-container" id="thumbnail-preview">
                <p>No thumbnail selected</p>
              </div>
            </div>
            
            <div class="form-group">
              <button type="submit" class="button hover-glow">DEPOSIT ARTIFACT</button>
              <a href="/scrapyard" class="button">CANCEL</a>
            </div>
          </form>
        `;
        
        // Initialize file preview for local uploads
        initLocalFilePreview();
      }
    }

    /**
     * Render categories and tags reference
     */
    function renderCategoriesReference(data) {
      const categoriesRefEl = document.getElementById('categories-reference');
      
      const categoriesHtml = `
        <div class="reference-section">
          <h3>CATEGORIES</h3>
          <div class="reference-grid">
            ${data.categories.map(cat => `
              <div class="reference-item">
                <div class="reference-name">${cat.display_name || cat.name}</div>
                <div class="reference-description">${cat.description || 'No description available'}</div>
              </div>
            `).join('')}
          </div>
        </div>
      `;
      
      const tagsHtml = data.tags && data.tags.length > 0 ? `
        <div class="reference-section">
          <h3>COMMON TAGS</h3>
          <div class="tag-cloud">
            ${data.tags.map(tag => `<span class="tag">${tag.name}</span>`).join('')}
          </div>
        </div>
      ` : '';
      
      categoriesRefEl.innerHTML = categoriesHtml + tagsHtml + `
        <div class="reference-section">
          <h3>GUIDELINES</h3>
          <ul class="reference-list">
            <li>Be descriptive with titles - help others find your work</li>
            <li>Use appropriate categories and tags</li>
            <li>Provide clear usage instructions in the description</li>
            <li>Include a thumbnail for non-image assets</li>
            <li>Maximum file size: 5MB</li>
          </ul>
        </div>
      `;
    }

    /**
     * Initialize S3 direct uploads
     */
    function initS3Uploads() {
      // Set up drag and drop areas
      const assetUploadArea = document.getElementById('asset-upload-area');
      const assetFileInput = document.getElementById('asset-file');
      const assetPreview = document.getElementById('asset-preview');
      
      const thumbnailUploadArea = document.getElementById('thumbnail-upload-area');
      const thumbnailFileInput = document.getElementById('thumbnail-file');
      const thumbnailPreview = document.getElementById('thumbnail-preview');
      
      // Asset file upload area
      assetUploadArea.addEventListener('click', () => {
        assetFileInput.click();
      });
      
      assetUploadArea.addEventListener('dragover', (e) => {
        e.preventDefault();
        assetUploadArea.classList.add('active');
      });
      
      assetUploadArea.addEventListener('dragleave', () => {
        assetUploadArea.classList.remove('active');
      });
      
      assetUploadArea.addEventListener('drop', (e) => {
        e.preventDefault();
        assetUploadArea.classList.remove('active');
        
        if (e.dataTransfer.files.length) {
          assetFileInput.files = e.dataTransfer.files;
          handleAssetFileSelect(e.dataTransfer.files[0]);
        }
      });
      
      assetFileInput.addEventListener('change', (e) => {
        if (e.target.files.length) {
          handleAssetFileSelect(e.target.files[0]);
        }
      });
      
      // Thumbnail file upload area
      thumbnailUploadArea.addEventListener('click', () => {
        thumbnailFileInput.click();
      });
      
      thumbnailUploadArea.addEventListener('dragover', (e) => {
        e.preventDefault();
        thumbnailUploadArea.classList.add('active');
      });
      
      thumbnailUploadArea.addEventListener('dragleave', () => {
        thumbnailUploadArea.classList.remove('active');
      });
      
      thumbnailUploadArea.addEventListener('drop', (e) => {
        e.preventDefault();
        thumbnailUploadArea.classList.remove('active');
        
        if (e.dataTransfer.files.length) {
          thumbnailFileInput.files = e.dataTransfer.files;
          handleThumbnailFileSelect(e.dataTransfer.files[0]);
        }
      });
      
      thumbnailFileInput.addEventListener('change', (e) => {
        if (e.target.files.length) {
          handleThumbnailFileSelect(e.target.files[0]);
        }
      });
      
      // Form submission
      const uploadForm = document.getElementById('s3-upload-form');
      uploadForm.addEventListener('submit', (e) => {
        e.preventDefault();
        submitS3Form();
      });
    }
    
    /**
     * Handle asset file selection and upload to S3
     */
    function handleAssetFileSelect(file) {
      const assetPreview = document.getElementById('asset-preview');
      const uploadStatus = document.getElementById('upload-status');
      
      // Update UI to show loading
      assetPreview.innerHTML = `<p>Uploading ${file.name}...</p>`;
      addScrapLog(`Preparing to upload ${file.name}`);
      
      // Get a presigned URL from the server
      fetch('/scrapyard/get-upload-url', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          filename: file.name,
          contentType: file.type,
          type: 'assets'
        })
      })
      .then(res => res.json())
      .then(data => {
        if (!data.success) {
          throw new Error(data.message || 'Failed to get upload URL');
        }
        
        addScrapLog(`Upload URL generated, beginning transfer...`);
        
        // Upload the file to S3
        return fetch(data.signedUrl, {
          method: 'PUT',
          headers: {
            'Content-Type': file.type
          },
          body: file
        }).then(() => {
          // Store the key and URL in hidden fields
          document.getElementById('assetKey').value = data.key;
          document.getElementById('assetUrl').value = data.url;
          
          return data;
        });
      })
      .then(data => {
        addScrapLog(`Asset uploaded successfully`);
        
        // Generate preview based on file type
        const fileExt = file.name.split('.').pop().toLowerCase();
        const isImage = ['jpg', 'jpeg', 'png', 'gif', 'webp', 'svg'].includes(fileExt);
        
        if (isImage) {
          assetPreview.innerHTML = `
            <img src="${data.url}" alt="${file.name}">
            <p>${file.name} (${formatFileSize(file.size)})</p>
          `;
        } else {
          assetPreview.innerHTML = `
            <div class="file-icon">${fileExt.toUpperCase()}</div>
            <p>${file.name} (${formatFileSize(file.size)})</p>
          `;
        }
      })
      .catch(err => {
        console.error('Error uploading file:', err);
        assetPreview.innerHTML = `<p>Error uploading file: ${err.message}</p>`;
        addScrapLog(`Upload error: ${err.message}`);
      });
    }
    
    /**
     * Handle thumbnail file selection and upload to S3
     */
    function handleThumbnailFileSelect(file) {
      const thumbnailPreview = document.getElementById('thumbnail-preview');
      
      // Check if it's an image
      const fileExt = file.name.split('.').pop().toLowerCase();
      const isImage = ['jpg', 'jpeg', 'png', 'gif', 'webp', 'svg'].includes(fileExt);
      
      if (!isImage) {
        thumbnailPreview.innerHTML = `<p>Error: Thumbnail must be an image file</p>`;
        return;
      }
      
      // Update UI to show loading
      thumbnailPreview.innerHTML = `<p>Uploading ${file.name}...</p>`;
      addScrapLog(`Preparing to upload thumbnail ${file.name}`);
      
      // Get a presigned URL from the server
      fetch('/scrapyard/get-upload-url', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          filename: file.name,
          contentType: file.type,
          type: 'thumbnails'
        })
      })
      .then(res => res.json())
      .then(data => {
        if (!data.success) {
          throw new Error(data.message || 'Failed to get upload URL');
        }
        
        addScrapLog(`Thumbnail URL generated, beginning transfer...`);
        
        // Upload the file to S3
        return fetch(data.signedUrl, {
          method: 'PUT',
          headers: {
            'Content-Type': file.type
          },
          body: file
        }).then(() => {
          // Store the key and URL in hidden fields
          document.getElementById('thumbnailKey').value = data.key;
          document.getElementById('thumbnailUrl').value = data.url;
          
          return data;
        });
      })
      .then(data => {
        addScrapLog(`Thumbnail uploaded successfully`);
        
        // Show preview
        thumbnailPreview.innerHTML = `
          <img src="${data.url}" alt="${file.name}">
          <p>${file.name} (${formatFileSize(file.size)})</p>
        `;
      })
      .catch(err => {
        console.error('Error uploading thumbnail:', err);
        thumbnailPreview.innerHTML = `<p>Error uploading thumbnail: ${err.message}</p>`;
        addScrapLog(`Upload error: ${err.message}`);
      });
    }
    
    /**
     * Submit the S3 form
     */
    function submitS3Form() {
      const form = document.getElementById('s3-upload-form');
      const uploadStatus = document.getElementById('upload-status');
      
      // Get form values
      const title = document.getElementById('title').value;
      const description = document.getElementById('description').value;
      const category_id = document.getElementById('category_id').value;
      const asset_type = document.getElementById('asset_type').value;
      const is_free = document.getElementById('is_free').value;
      const tags = document.getElementById('tags').value;
      const assetKey = document.getElementById('assetKey').value;
      const assetUrl = document.getElementById('assetUrl').value;
      const thumbnailKey = document.getElementById('thumbnailKey').value;
      const thumbnailUrl = document.getElementById('thumbnailUrl').value;
      
      // Validate required fields
      if (!title || !description || !category_id || !asset_type || !assetKey || !assetUrl) {
        uploadStatus.innerHTML = `<div class="error-message">Required fields are missing</div>`;
        return;
      }
      
      // Show loading
      uploadStatus.innerHTML = `<div class="loading-message">Processing artifact submission...</div>`;
      addScrapLog(`Processing artifact submission`);
      
      // Submit to the server
      fetch('/scrapyard/upload-s3', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          title,
          description,
          category_id,
          asset_type,
          is_free,
          tags,
          assetKey,
          assetUrl,
          thumbnailKey,
          thumbnailUrl
        })
      })
      .then(res => res.json())
      .then(data => {
        if (data.success) {
          addScrapLog(`Artifact deposit successful. ID: ${data.assetId}`);
          uploadStatus.innerHTML = `<div class="success-message">Artifact deposit successful!</div>`;
          
          // Redirect to the asset page
          setTimeout(() => {
            window.location.href = data.redirect || `/scrapyard/asset/${data.assetId}`;
          }, 1500);
        } else {
          throw new Error(data.message || 'Unknown error');
        }
      })
      .catch(err => {
        console.error('Error submitting form:', err);
        uploadStatus.innerHTML = `<div class="error-message">Error: ${err.message}</div>`;
        addScrapLog(`Submission error: ${err.message}`);
      });
    }
    
    /**
     * Initialize local file preview
     */
    function initLocalFilePreview() {
      const assetInput = document.getElementById('asset');
      const assetPreview = document.getElementById('asset-preview');
      
      const thumbnailInput = document.getElementById('thumbnail');
      const thumbnailPreview = document.getElementById('thumbnail-preview');
      
      // Asset file preview
      assetInput.addEventListener('change', (e) => {
        if (e.target.files.length) {
          const file = e.target.files[0];
          const fileExt = file.name.split('.').pop().toLowerCase();
          const isImage = ['jpg', 'jpeg', 'png', 'gif', 'webp', 'svg'].includes(fileExt);
          
          if (isImage) {
            const reader = new FileReader();
            reader.onload = (event) => {
              assetPreview.innerHTML = `
                <img src="${event.target.result}" alt="${file.name}">
                <p>${file.name} (${formatFileSize(file.size)})</p>
              `;
            };
            reader.readAsDataURL(file);
          } else {
            assetPreview.innerHTML = `
              <div class="file-icon">${fileExt.toUpperCase()}</div>
              <p>${file.name} (${formatFileSize(file.size)})</p>
            `;
          }
          
          addScrapLog(`Asset file selected: ${file.name}`);
        }
      });
      
      // Thumbnail file preview
      thumbnailInput.addEventListener('change', (e) => {
        if (e.target.files.length) {
          const file = e.target.files[0];
          const fileExt = file.name.split('.').pop().toLowerCase();
          const isImage = ['jpg', 'jpeg', 'png', 'gif', 'webp', 'svg'].includes(fileExt);
          
          if (isImage) {
            const reader = new FileReader();
            reader.onload = (event) => {
              thumbnailPreview.innerHTML = `
                <img src="${event.target.result}" alt="${file.name}">
                <p>${file.name} (${formatFileSize(file.size)})</p>
              `;
            };
            reader.readAsDataURL(file);
            
            addScrapLog(`Thumbnail file selected: ${file.name}`);
          } else {
            thumbnailPreview.innerHTML = `<p>Error: Thumbnail must be an image file</p>`;
            addScrapLog(`Invalid thumbnail file: ${file.name}`);
          }
        }
      });
      
      // Form submission
      const uploadForm = document.getElementById('local-upload-form');
      uploadForm.addEventListener('submit', (e) => {
        // Add log entry
        addScrapLog(`Submitting artifact data...`);
      });
    }
    
    /**
     * Format file size in human-readable format
     */
    function formatFileSize(bytes) {
      if (bytes < 1024) {
        return bytes + ' B';
      } else if (bytes < 1024 * 1024) {
        return (bytes / 1024).toFixed(1) + ' KB';
      } else {
        return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
      }
    }
    
    /**
     * Initialize tag system
     */
    function initTagSystem() {
      const tagsInput = document.getElementById('tags');
      const selectedTagsContainer = document.getElementById('selected-tags');
      const tagSuggestionsContainer = document.getElementById('tag-suggestions');
      
      // Function to fetch tag suggestions
      const fetchTagSuggestions = (search) => {
        fetch(`/scrapyard/api/tags?search=${encodeURIComponent(search)}`)
          .then(res => res.json())
          .then(data => {
            if (data.success && data.tags.length > 0) {
              tagSuggestionsContainer.innerHTML = '';
              
              data.tags.forEach(tag => {
                const tagEl = document.createElement('span');
                tagEl.className = 'tag suggestion';
                tagEl.textContent = tag.name;
                tagEl.addEventListener('click', () => {
                  addTag(tag.name);
                });
                
                tagSuggestionsContainer.appendChild(tagEl);
              });
            } else {
              tagSuggestionsContainer.innerHTML = '';
            }
          })
          .catch(err => {
            console.error('Error fetching tag suggestions:', err);
          });
      };
      
      // Function to add a tag
      const addTag = (tagName) => {
        const currentTags = tagsInput.value.split(',').map(t => t.trim()).filter(t => t);
        
        if (!currentTags.includes(tagName)) {
          currentTags.push(tagName);
          tagsInput.value = currentTags.join(', ');
          
          // Update selected tags display
          updateSelectedTags();
        }
      };
      
      // Function to update selected tags display
      const updateSelectedTags = () => {
        const currentTags = tagsInput.value.split(',').map(t => t.trim()).filter(t => t);
        
        selectedTagsContainer.innerHTML = '';
        
        currentTags.forEach(tagName => {
          const tagEl = document.createElement('span');
          tagEl.className = 'tag selected';
          tagEl.innerHTML = `${tagName} <span class="remove-tag">×</span>`;
          
          tagEl.querySelector('.remove-tag').addEventListener('click', () => {
            removeTag(tagName);
          });
          
          selectedTagsContainer.appendChild(tagEl);
        });
      };
      
      // Function to remove a tag
      const removeTag = (tagName) => {
        const currentTags = tagsInput.value.split(',').map(t => t.trim()).filter(t => t);
        const updatedTags = currentTags.filter(t => t !== tagName);
        
        tagsInput.value = updatedTags.join(', ');
        
        // Update selected tags display
        updateSelectedTags();
      };
      
      // Set up event listeners
      tagsInput.addEventListener('input', (e) => {
        const inputValue = e.target.value.trim();
        const lastTag = inputValue.split(',').pop().trim();
        
        if (lastTag.length > 0) {
          fetchTagSuggestions(lastTag);
        } else {
          tagSuggestionsContainer.innerHTML = '';
        }
        
        updateSelectedTags();
      });
      
      tagsInput.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
          e.preventDefault();
          
          const inputValue = e.target.value.trim();
          const lastTag = inputValue.split(',').pop().trim();
          
          if (lastTag.length > 0) {
            addTag(lastTag);
          }
        }
      });
      
      // Initialize selected tags
      updateSelectedTags();
    }

    /**
     * Initialize scrap log with dynamic updates
     */
    function initScrapLog() {
      const systemLog = document.getElementById('system-log');
      if (!systemLog) return;

      // Possible log messages for upload view
      const possibleLogs = [
        'Checking storage capacity: %d% available',
        'Signal strength optimal for upload',
        'Artifact classification matrix ready',
        'Tag system database connected',
        'Preparing compression for large files'
      ];

      // Format log message with random values
      const formatLogMessage = (message) => {
        return message.replace('%d', Math.floor(Math.random() * 100));
      };

      // Add new log periodically
      let logInterval = setInterval(() => {
        // Only add logs if the page is visible
        if (document.hidden) return;

        if (Math.random() < 0.3) { // 30% chance to add a new log
          const currentTime = new Date();
          const timeString = currentTime.toLocaleTimeString('en-US', {
            hour12: false,
            hour: '2-digit',
            minute: '2-digit',
            second: '2-digit'
          });

          const logMessage = possibleLogs[Math.floor(Math.random() * possibleLogs.length)];
          const formattedMessage = formatLogMessage(logMessage);

          const logEntry = document.createElement('div');
          logEntry.className = 'log-entry';
          logEntry.innerHTML = `
            <span class="log-time">${timeString}</span>
            <span class="log-text">${formattedMessage}</span>
          `;

          // Add to top of log
          systemLog.insertBefore(logEntry, systemLog.firstChild);

          // Remove old logs if too many
          while (systemLog.children.length > 10) {
            systemLog.removeChild(systemLog.lastChild);
          }
        }
      }, 6000);

      // Clean up interval when page is hidden
      document.addEventListener('visibilitychange', () => {
        if (document.hidden && logInterval) {
          clearInterval(logInterval);
          logInterval = null;
        } else if (!document.hidden && !logInterval) {
          logInterval = setInterval(addRandomLog, 6000);
        }
      });

      // Clean up on page unload
      window.addEventListener('beforeunload', () => {
        if (logInterval) {
          clearInterval(logInterval);
          logInterval = null;
        }
      });
    }

    /**
     * Add a message to the scrap log
     */
    function addScrapLog(message) {
      const systemLog = document.getElementById('system-log');
      if (!systemLog) return;

      const currentTime = new Date();
      const timeString = currentTime.toLocaleTimeString('en-US', {
        hour12: false,
        hour: '2-digit',
        minute: '2-digit',
        second: '2-digit'
      });

      const logEntry = document.createElement('div');
      logEntry.className = 'log-entry';
      logEntry.innerHTML = `
        <span class="log-time">${timeString}</span>
        <span class="log-text">${message}</span>
      `;

      // Add with highlight effect
      logEntry.classList.add('highlight');
      setTimeout(() => {
        logEntry.classList.remove('highlight');
      }, 2000);

      // Add to top of log
      systemLog.insertBefore(logEntry, systemLog.firstChild);

      // Remove old logs if too many
      if (systemLog.children.length > 15) {
        systemLog.removeChild(systemLog.lastChild);
      }
    }

    /**
     * Add event listeners for interactive elements
     */
    function addEventListeners() {
      // Toggle glitch effects
      const glitchToggle = document.getElementById('toggle-glitch');
      if (glitchToggle) {
        glitchToggle.addEventListener('click', function(e) {
          e.preventDefault();
          document.body.classList.toggle('glitch-active');
          
          // Store preference in localStorage
          localStorage.setItem('glitch-active', document.body.classList.contains('glitch-active') ? 'true' : 'false');
        });
      }

      // Check if glitch effects were previously enabled
      const glitchActive = localStorage.getItem('glitch-active');
      if (glitchActive === 'true') {
        document.body.classList.add('glitch-active');
      }

      // Mobile navigation toggle
      const mobileNavToggle = document.getElementById('mobile-nav-toggle');
      const sidebar = document.getElementById('main-sidebar');

      if (mobileNavToggle && sidebar) {
        mobileNavToggle.addEventListener('click', function() {
          sidebar.classList.toggle('active');
          this.textContent = sidebar.classList.contains('active') ? 'HIDE NAVIGATION' : 'SHOW NAVIGATION';
          
          // Store sidebar state in localStorage
          localStorage.setItem('sidebar-active', sidebar.classList.contains('active') ? 'true' : 'false');
        });

        // Set initial state on page load
        const sidebarActive = localStorage.getItem('sidebar-active');
        if (sidebarActive === 'true') {
          sidebar.classList.add('active');
          mobileNavToggle.textContent = 'HIDE NAVIGATION';
        }
      }
      
      // Initialize tag system
      initTagSystem();
    }
  </script>
</body>
</html>