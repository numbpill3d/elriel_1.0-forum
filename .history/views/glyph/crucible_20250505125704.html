<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>GLYPH CRUCIBLE | Digital Wasteland</title>

  <!-- SEO Meta Tags -->
  <meta name="description" content="Create digital sigils in the Glyph Crucible. Generate unique patterns that resonate with the digital wasteland.">
  <meta name="keywords" content="elriel, glyph crucible, digital sigils, cyberpunk, retro web, hacker aesthetics">

  <!-- Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=VT323&family=Share+Tech+Mono&family=IBM+Plex+Mono&display=swap" rel="stylesheet">

  <!-- Stylesheets -->
  <link rel="stylesheet" href="/css/cyberpunk-terminal.css">
  <link rel="stylesheet" href="/css/glyph.css">
  <link rel="stylesheet" href="/css/glyph-loading.css">

  <!-- Scripts -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
  <script src="/js/cyberpunk-terminal.js" defer></script>
  <script src="/js/glyph3d.js" defer></script>
</head>
<body class="terminal">
  <!-- Screen Effects -->
  <div class="noise-overlay"></div>
  <div class="scan-lines"></div>
  <div class="crt-effect"></div>

  <!-- Main Container -->
  <div class="container">
    <header class="main-header">
      <div class="logo">
        <h1 class="glitch" data-text="ELRIEL">ELRIEL</h1>
        <div class="logo-subtitle">DIGITAL WASTELAND v1.3.7</div>
      </div>
      <div class="user-panel">
        <div id="user-status">
          <!-- User status will be injected here -->
        </div>
      </div>
    </header>

    <div class="content-wrapper">
      <nav class="sidebar">
        <div class="nav-section">
          <h3 class="nav-title">MAIN SYSTEMS</h3>
          <ul class="nav-links">
            <li><a href="/">TERMINAL</a></li>
            <li><a href="/feed/bleedstream">BLEEDSTREAM</a></li>
            <li><a href="/glyph/crucible" class="active">GLYPH CRUCIBLE</a></li>
            <li><a href="/whisper/board">WHISPERBOARD</a></li>
            <li><a href="/forum/scrapyard">SCRAPYARD</a></li>
          </ul>
        </div>
        <div class="nav-section">
          <h3 class="nav-title">PROFILE</h3>
          <ul class="nav-links">
            <li><a href="/profile">DASHBOARD</a></li>
            <li><a href="/profile/edit">EDIT PROFILE</a></li>
            <li><a href="/feed/new">CREATE POST</a></li>
          </ul>
        </div>
        <div class="nav-section">
          <h3 class="nav-title">SYSTEM</h3>
          <ul class="nav-links">
            <li><a href="/about">ABOUT</a></li>
            <li><a href="#" id="toggle-glitch">TOGGLE GLITCH</a></li>
          </ul>
        </div>
      </nav>

      <main class="main-content">
        <!-- System Log Sidebar -->
        <aside class="system-log-sidebar">
          <div class="panel-header">
            <h2>CRUCIBLE LOG</h2>
            <div class="status-indicator">LIVE</div>
          </div>
          <div class="panel-content" id="system-log">
            <div class="log-entry">
              <span class="log-time">06:45:12</span>
              <span class="log-text">Crucible subsystems initialized</span>
            </div>
            <div class="log-entry">
              <span class="log-time">06:47:03</span>
              <span class="log-text">Connected to sigil database</span>
            </div>
            <div class="log-entry">
              <span class="log-time">06:48:22</span>
              <span class="log-text">Psychogeometric algorithms loaded</span>
            </div>
            <div class="log-entry">
              <span class="log-time">06:50:45</span>
              <span class="log-text">Pattern recognition at 94% efficiency</span>
            </div>
            <div class="log-entry">
              <span class="log-time">06:54:31</span>
              <span class="log-text">User [REDACTED] accessed glyph archives</span>
            </div>
            <div class="log-entry">
              <span class="log-time">06:58:17</span>
              <span class="log-text">Reality anchor points established</span>
            </div>
          </div>
        </aside>

        <!-- Main Crucible Panel -->
        <section class="panel crucible-panel">
          <div class="scanner-line"></div>
          <div class="panel-header">
            <h2>GLYPH CRUCIBLE</h2>
            <div class="status-indicator alert">ACTIVE</div>
          </div>
          <div class="panel-content crucible-content">
            <div class="crucible-controls">
              <div class="form-group">
                <label for="seed">SEED PHRASE:</label>
                <input type="text" id="seed" name="seed" placeholder="Leave empty for random pattern" class="hover-glow">
              </div>
              <div class="form-group">
                <label for="complexity">COMPLEXITY:</label>
                <select id="complexity" name="complexity" class="hover-glow">
                  <option value="low">LOW</option>
                  <option value="medium" selected>MEDIUM</option>
                  <option value="high">HIGH</option>
                  <option value="extreme">EXTREME</option>
                </select>
              </div>
              <button id="generate-glyph" class="button hover-glow">GENERATE SIGIL</button>
            </div>

            <div class="generated-glyph-area">
              <div id="generated-glyph-svg" class="generated-glyph-svg">
                <!-- Generated glyph SVG will be injected here -->
                <div class="loading-indicator">AWAITING INPUT</div>
              </div>
              <div class="glyph-actions">
                <button id="play-audio" class="button hover-glow" style="display: none;">PLAY AUDIO</button>
                <button id="save-glyph" class="button hover-glow" style="display: none;">SAVE SIGIL</button>
                <div id="generation-message" style="color: var(--terminal-green); margin-top: 1rem;"></div>
                <div id="generation-error" class="glitch-effect" style="margin-top: 1rem; display: none;"></div>
              </div>
            </div>
          </div>
        </section>

        <!-- User's Saved Glyphs Panel -->
        <section class="panel user-glyphs-panel">
          <div class="scanner-line"></div>
          <div class="panel-header">
            <h2>YOUR SAVED SIGILS</h2>
            <div class="status-indicator">ARCHIVE</div>
          </div>
          <div class="panel-content user-glyphs-content" id="user-glyphs-content">
            <!-- User's saved glyphs will be injected here -->
            <div class="glyph-grid">
              <!-- Will be populated by JavaScript -->
            </div>
          </div>
        </section>

        <!-- Symbol Reference Panel -->
        <section class="panel ascii-panel">
          <div class="scanner-line"></div>
          <div class="panel-header">
            <h2>SYMBOL REFERENCE</h2>
            <div class="status-indicator">ARCHIVE</div>
          </div>
          <div class="panel-content ascii-content">
            <div class="ascii-grid">
              <div class="ascii-cell" id="symbol1">
                <!-- Will be populated by JS -->
              </div>
              <div class="ascii-cell" id="symbol2">
                <!-- Will be populated by JS -->
              </div>
              <div class="ascii-cell" id="symbol3">
                <!-- Will be populated by JS -->
              </div>
            </div>
          </div>
        </section>
      </main>
    </div>

    <footer class="main-footer">
      <div class="footer-text">ELRIEL NETWORK // ESTABLISHED 2025 // ALL RIGHTS SURRENDERED</div>
      <div class="footer-glyphs">
        <span class="glyph" data-symbol="command">⌘</span>
        <span class="glyph" data-symbol="star">⍟</span>
        <span class="glyph" data-symbol="node">⎔</span>
      </div>
    </footer>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', function() {
      console.log('[GLYPH CRUCIBLE] Initializing systems...');

      // Initialize all crucible components
      initBootstrapSequence();
      initGlyphData();
      initSymbolReferences();
      initCrucibleLog();
      initGlyphGeneration();

      // Dispatch system ready event
      setTimeout(() => {
        console.log('[GLYPH CRUCIBLE] All systems operational.');
        document.dispatchEvent(new CustomEvent('crucibleReady'));
      }, 1000);
    });

    /**
     * Bootstrap sequence - initial loading animation
     */
    function initBootstrapSequence() {
      // Create a visual effect when entering the crucible
      const bootstrapEffect = () => {
        document.body.classList.add('glitch-active');
        setTimeout(() => {
          document.body.classList.remove('glitch-active');
        }, 500);
      };

      // Add delayed bootstrap visual effect
      setTimeout(bootstrapEffect, 300);
      setTimeout(bootstrapEffect, 800);
      setTimeout(bootstrapEffect, 1200);
    }

    /**
     * Initialize glyph data and user information
     */
    function initGlyphData() {
      // Add error handling for data injection
      let data, user, userGlyphs = [];
      try {
        // Inject data from server
        data = JSON.parse('__DATA__'.replace(/\\n/g, "\\n")
          .replace(/\\'/g, "\\'")
          .replace(/\\"/g, '\\"')
          .replace(/\\&/g, "\\&")
          .replace(/\\r/g, "\\r")
          .replace(/\\t/g, "\\t")
          .replace(/\\b/g, "\\b")
          .replace(/\\f/g, "\\f"));
        user = data.user;
        userGlyphs = data.userGlyphs || [];
        console.log("[GLYPH CRUCIBLE] Glyph data loaded successfully:", {
          hasUser: !!user,
          glyphCount: userGlyphs.length
        });
      } catch (err) {
        console.error("[GLYPH CRUCIBLE] Error parsing injected data:", err);
        // Set default values
        data = {};
        user = null;
        userGlyphs = [];
      }

      // Update user status in header
      const userStatusEl = document.getElementById('user-status');
      if (user) {
        userStatusEl.innerHTML = `
          <div class="logged-in">
            <span class="username">${user.username}</span>
            <div class="user-links">
              <a href="/profile" class="button">PROFILE</a>
              <a href="/auth/logout" class="button">LOGOUT</a>
            </div>
          </div>
        `;
      } else {
        userStatusEl.innerHTML = `
          <div class="logged-out">
            <a href="/auth/login" class="button login-btn">LOGIN</a>
            <a href="/auth/register" class="button register-btn">REGISTER</a>
          </div>
        `;
      }

      // Display user's saved glyphs
      const userGlyphsContentEl = document.getElementById('user-glyphs-content');
      const glyphGrid = document.createElement('div');
      glyphGrid.className = 'glyph-grid';

      if (userGlyphs && userGlyphs.length > 0) {
        userGlyphs.forEach(glyph => {
          const glyphItem = document.createElement('div');
          glyphItem.className = 'user-glyph-item hover-glow';
          glyphItem.innerHTML = glyph.svg_data;
          glyphItem.setAttribute('data-glyph-id', glyph.id);
          glyphItem.title = `Generated: ${new Date(glyph.created_at).toLocaleString()}`;

          // Add glyph metadata beneath
          const glyphMeta = document.createElement('div');
          glyphMeta.className = 'glyph-meta';
          glyphMeta.innerHTML = `
            <div class="glyph-id">#${glyph.id.toString().padStart(4, '0')}</div>
            <div class="glyph-date">${new Date(glyph.created_at).toLocaleDateString()}</div>
          `;

          // Add click event to view glyph
          glyphItem.addEventListener('click', () => {
            // Add glitch effect when clicking
            glyphItem.classList.add('glitch-text');
            setTimeout(() => {
              window.location.href = `/glyph/view/${glyph.id}`;
            }, 300);
          });

          const glyphContainer = document.createElement('div');
          glyphContainer.className = 'glyph-container';
          glyphContainer.appendChild(glyphItem);
          glyphContainer.appendChild(glyphMeta);

          glyphGrid.appendChild(glyphContainer);
        });

        userGlyphsContentEl.innerHTML = '';
        userGlyphsContentEl.appendChild(glyphGrid);
      } else {
        userGlyphsContentEl.innerHTML = `
          <div class="empty-state">
            <div class="empty-icon">⧠</div>
            <div class="empty-message">NO SAVED SIGILS FOUND</div>
            <div class="empty-subtitle">Generate new sigils using the crucible above</div>
          </div>
        `;
      }

      // Store data in global scope for other functions
      window.crucibleData = { data, user, userGlyphs };
    }

    /**
     * Initialize symbol reference panel
     */
    function initSymbolReferences() {
      const symbolCells = [
        document.getElementById('symbol1'),
        document.getElementById('symbol2'),
        document.getElementById('symbol3')
      ];

      const symbols = [
        {
          title: "VECTOR ANCHOR",
          ascii: `
   /\\
  /  \\
 /    \\
/      \\
--------
|      |
|      |
--------`,
          description: "The foundational vector anchor point used in all glyphs."
        },
        {
          title: "PHASE NODE",
          ascii: `
    O
   /|\\
  / | \\
 /__|__\\
|   |   |
|___|___|`,
          description: "Connects dimensional pathways through the crucible."
        },
        {
          title: "CASCADE CIRCUIT",
          ascii: `
 _______
|  ___  |
| |   | |
| |___| |
|_______|
   | |
 \\_/ \\_/`,
          description: "Self-reinforcing pattern used in higher complexity glyphs."
        }
      ];

      // Apply symbols to cells
      symbolCells.forEach((cell, index) => {
        if (!cell || index >= symbols.length) return;

        const symbol = symbols[index];

        const symTitle = document.createElement('div');
        symTitle.className = 'symbol-title';
        symTitle.textContent = symbol.title;

        const symArt = document.createElement('pre');
        symArt.className = 'ascii-art';
        symArt.textContent = symbol.ascii;

        const symDesc = document.createElement('div');
        symDesc.className = 'symbol-description';
        symDesc.textContent = symbol.description;

        cell.appendChild(symTitle);
        cell.appendChild(symArt);
        cell.appendChild(symDesc);

        // Add animation class
        const animations = ['pulse-glow', 'blink-glow', 'flicker-glow'];
        symArt.classList.add(animations[index % animations.length]);

        // Make interactive
        cell.addEventListener('click', () => {
          const currentAnim = animations[index % animations.length];
          symArt.classList.remove(currentAnim);

          // Rotate animation
          const nextIndex = (index + 1) % animations.length;
          symArt.classList.add(animations[nextIndex]);

          // Play sound effect
          if (window.elrielTerminal && window.elrielTerminal.playGlitchSound) {
            window.elrielTerminal.playGlitchSound();
          }
        });
      });
    }

    /**
     * Initialize crucible log with dynamic updates
     */
    function initCrucibleLog() {
      const systemLog = document.getElementById('system-log');
      if (!systemLog) return;

      // Possible log messages for crucible
      const possibleLogs = [
        'Neural pattern %d detected',
        'Sigil resonance at %d% strength',
        'Reality filter activated',
        'Symbol library access granted',
        'Processing equation sequence %s',
        'Dimensional anchor stabilized',
        'Pattern recursion level %d',
        'User synchronization established',
        'Subpattern %s recognized',
        'Memory fragment recovered'
      ];

      // Random string generator
      const randomString = () => {
        const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
        return Array(4).fill().map(() => chars.charAt(Math.floor(Math.random() * chars.length))).join('');
      };

      // Format log message with random values
      const formatLogMessage = (message) => {
        return message
          .replace('%d', Math.floor(Math.random() * 100))
          .replace('%s', randomString());
      };

      // Add new log periodically
      setInterval(() => {
        if (Math.random() < 0.3) { // 30% chance to add a new log
          const currentTime = new Date();
          const timeString = currentTime.toLocaleTimeString('en-US', {
            hour12: false,
            hour: '2-digit',
            minute: '2-digit',
            second: '2-digit'
          });

          const logMessage = possibleLogs[Math.floor(Math.random() * possibleLogs.length)];
          const formattedMessage = formatLogMessage(logMessage);

          const logEntry = document.createElement('div');
          logEntry.className = 'log-entry';
          logEntry.innerHTML = `
            <span class="log-time">${timeString}</span>
            <span class="log-text">${formattedMessage}</span>
          `;

          // Add to top of log
          systemLog.insertBefore(logEntry, systemLog.firstChild);

          // Remove old logs if too many
          if (systemLog.children.length > 15) {
            systemLog.removeChild(systemLog.lastChild);
          }
        }
      }, 5000); // Check every 5 seconds
    }

    /**
     * Initialize glyph generation functionality
     */
    function initGlyphGeneration() {
      const generateGlyphBtn = document.getElementById('generate-glyph');
      const seedInput = document.getElementById('seed');
      const complexitySelect = document.getElementById('complexity');
      const generatedGlyphSvgEl = document.getElementById('generated-glyph-svg');
      const playAudioBtn = document.getElementById('play-audio');
      const saveGlyphBtn = document.getElementById('save-glyph');
      const generationMessageEl = document.getElementById('generation-message');
      const generationErrorEl = document.getElementById('generation-error');

      let currentGeneratedGlyph = null;

      generateGlyphBtn.addEventListener('click', async () => {
        const seed = seedInput.value.trim();
        const complexity = complexitySelect.value;

        // Add glyph generation sequence effects
        document.body.classList.add('glitch-active');
        setTimeout(() => {
          document.body.classList.remove('glitch-active');
        }, 300);

        generationMessageEl.textContent = '';
        generationErrorEl.style.display = 'none';
        generationErrorEl.textContent = '';

        // Loading animation
        generatedGlyphSvgEl.innerHTML = `
          <div class="generation-loading">
            <div class="loading-indicator">INITIALIZING GLYPH MATRIX</div>
            <div class="crucible-pulse"></div>
          </div>
        `;

        playAudioBtn.style.display = 'none';
        saveGlyphBtn.style.display = 'none';
        currentGeneratedGlyph = null;

        // Log generation attempt
        addCrucibleLog(`Generating glyph with seed: ${seed || 'RANDOM'}`);

        try {
          const response = await fetch('/glyph/generate', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({ seed, complexity })
          });

          const data = await response.json();

          if (data.success) {
            currentGeneratedGlyph = data.glyph;

            // Enhanced rendering with animation
            setTimeout(() => {
              generatedGlyphSvgEl.innerHTML = currentGeneratedGlyph.svgData;

              // Add animation to the glyph
              const svgElement = generatedGlyphSvgEl.querySelector('svg');
              if (svgElement) {
                svgElement.classList.add('glyph-appear');
              }

              playAudioBtn.style.display = 'inline-block';

              // Only show save button if logged in
              if (window.crucibleData && window.crucibleData.user) {
                saveGlyphBtn.style.display = 'inline-block';
              }

              generationMessageEl.textContent = 'SIGIL GENERATION SUCCESSFUL';
              addCrucibleLog(`Glyph generated successfully, complexity: ${complexity}`);
            }, 1500); // Delay for dramatic effect
          } else {
            generatedGlyphSvgEl.innerHTML = `
              <div class="generation-error">
                <div class="error-icon">⚠</div>
                <div class="error-message">GENERATION FAILED</div>
              </div>
            `;
            generationErrorEl.textContent = data.message || 'Glyph generation failed. Unknown error.';
            generationErrorEl.style.display = 'block';
            addCrucibleLog(`Error: Glyph generation failed`);
          }
        } catch (error) {
          console.error('[GLYPH CRUCIBLE] Generation error:', error);
          generatedGlyphSvgEl.innerHTML = `
            <div class="generation-error">
              <div class="error-icon">⚠</div>
              <div class="error-message">CONNECTION FAILED</div>
            </div>
          `;
          generationErrorEl.textContent = 'System error. Could not connect to crucible.';
          generationErrorEl.style.display = 'block';
          addCrucibleLog(`Critical error: Connection to crucible failed`);
        }
      });

      // Play glyph audio with Web Audio API
      playAudioBtn.addEventListener('click', () => {
        if (!currentGeneratedGlyph) return;

        try {
          const audioParams = currentGeneratedGlyph.audioData ?
                             JSON.parse(currentGeneratedGlyph.audioData) :
                             {
                               frequencies: [220, 440, 880],
                               durations: [0.2, 0.3, 0.5],
                               types: ['sine', 'square', 'sawtooth']
                             };

          console.log('[GLYPH CRUCIBLE] Playing audio with parameters:', audioParams);

          // Create Web Audio API components
          const audioContext = new (window.AudioContext || window.webkitAudioContext)();

          // Play sequence of tones
          const frequencies = audioParams.frequencies || [220, 440, 880];
          const durations = audioParams.durations || [0.2, 0.3, 0.5];
          const types = audioParams.types || ['sine', 'square', 'sawtooth'];

          // Sequential playback
          let startTime = audioContext.currentTime;

          frequencies.forEach((freq, index) => {
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();

            oscillator.type = types[index % types.length];
            oscillator.frequency.setValueAtTime(freq, startTime);

            gainNode.gain.setValueAtTime(0.01, startTime);
            gainNode.gain.exponentialRampToValueAtTime(0.3, startTime + 0.05);
            gainNode.gain.exponentialRampToValueAtTime(0.01, startTime + durations[index % durations.length]);

            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);

            oscillator.start(startTime);
            oscillator.stop(startTime + durations[index % durations.length]);

            startTime += durations[index % durations.length];
          });

          generationMessageEl.textContent = 'PLAYING AUDIO SEQUENCE...';
          setTimeout(() => {
            generationMessageEl.textContent = 'AUDIO PLAYBACK COMPLETE.';
          }, startTime * 1000 + 500);

          addCrucibleLog(`Playing audio pattern for current glyph`);
        } catch (e) {
          console.error('[GLYPH CRUCIBLE] Error playing audio:', e);
          generationErrorEl.textContent = 'Error playing audio. Corrupted data.';
          generationErrorEl.style.display = 'block';
        }
      });

      // Save glyph with enhanced effects
      saveGlyphBtn.addEventListener('click', async () => {
        if (!currentGeneratedGlyph) return;

        generationMessageEl.textContent = 'SAVING SIGIL...';
        generationErrorEl.style.display = 'none';
        generationErrorEl.textContent = '';

        // Add saving effect
        document.body.classList.add('glitch-active');
        setTimeout(() => {
          document.body.classList.remove('glitch-active');
        }, 200);

        addCrucibleLog(`Saving current glyph to user repository`);

        try {
          const response = await fetch('/glyph/save', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify(currentGeneratedGlyph)
          });

          const data = await response.json();

          if (data.success) {
            generationMessageEl.textContent = data.message || 'SIGIL SAVED SUCCESSFULLY';

            // Show success animation
            const svgElement = generatedGlyphSvgEl.querySelector('svg');
            if (svgElement) {
              svgElement.classList.add('glyph-success');
            }

            // Reload page with delay and transition
            setTimeout(() => {
              document.body.classList.add('fade-out');
              setTimeout(() => {
                window.location.reload();
              }, 500);
            }, 1500);

            addCrucibleLog(`Glyph saved successfully to user repository`);
          } else {
            generationErrorEl.textContent = data.message || 'Glyph save failed. Unknown error.';
            generationErrorEl.style.display = 'block';
            addCrucibleLog(`Error: Failed to save glyph`);
          }
        } catch (error) {
          console.error('[GLYPH CRUCIBLE] Save error:', error);
          generationErrorEl.textContent = 'System error. Could not save glyph.';
          generationErrorEl.style.display = 'block';
          addCrucibleLog(`Critical error: Repository connection failed`);
        }
      });

      // Toggle glitch effects
      document.getElementById('toggle-glitch').addEventListener('click', function(e) {
        e.preventDefault();
        document.body.classList.toggle('glitch-active');

        // Use the terminal glitch sound if available
        if (window.elrielTerminal && window.elrielTerminal.playGlitchSound) {
          window.elrielTerminal.playGlitchSound();
        }
      });
    }

    /**
     * Add a log entry to the crucible log
     */
    function addCrucibleLog(message) {
      const systemLog = document.getElementById('system-log');
      if (!systemLog) return;

      const currentTime = new Date();
      const timeString = currentTime.toLocaleTimeString('en-US', {
        hour12: false,
        hour: '2-digit',
        minute: '2-digit',
        second: '2-digit'
      });

      const logEntry = document.createElement('div');
      logEntry.className = 'log-entry';
      logEntry.innerHTML = `
        <span class="log-time">${timeString}</span>
        <span class="log-text">${message}</span>
      `;

      // Add with highlight effect
      logEntry.classList.add('highlight');
      setTimeout(() => {
        logEntry.classList.remove('highlight');
      }, 2000);

      // Add to top of log
      systemLog.insertBefore(logEntry, systemLog.firstChild);

      // Remove old logs if too many
      if (systemLog.children.length > 15) {
        systemLog.removeChild(systemLog.lastChild);
      }
    }
  </script>
</body>
</html>