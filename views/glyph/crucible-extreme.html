<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>EXTREME GLYPH CRUCIBLE | ELRIEL</title>
  <link rel="stylesheet" href="/css/main.css">
  <link rel="stylesheet" href="/css/glitch.css">
  <link rel="stylesheet" href="/css/glyph.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/tween.js/18.6.4/tween.umd.js"></script>
</head>
<body class="terminal">
  <div class="noise-overlay"></div>
  <div class="scan-lines"></div>
  <div class="container">
    <header class="main-header">
      <div class="logo">
        <h1 class="glitch" data-text="ELRIEL">ELRIEL</h1>
        <div class="logo-subtitle">TERMINAL ACCESS v1.0</div>
      </div>
      <div class="user-panel">
        <div id="user-status">
          <!-- User status will be injected here -->
        </div>
      </div>
    </header>

    <div class="content-wrapper">
      <nav class="sidebar">
        <div class="nav-section">
          <h3 class="nav-title">MAIN SYSTEMS</h3>
          <ul class="nav-links">
            <li><a href="/">TERMINAL</a></li>
            <li><a href="/feed/bleedstream">BLEEDSTREAM</a></li>
            <li><a href="/glyph/crucible" class="active">GLYPH CRUCIBLE</a></li>
            <li><a href="/whisper/board">WHISPERBOARD</a></li>
            <li><a href="/forum">FORUMS</a></li>
          </ul>
        </div>
        <div class="nav-section">
          <h3 class="nav-title">PROFILE</h3>
          <ul class="nav-links">
            <li><a href="/profile">DASHBOARD</a></li>
            <li><a href="/profile/edit">EDIT PROFILE</a></li>
            <li><a href="/feed/new">CREATE POST</a></li>
          </ul>
        </div>
        <div class="nav-section">
          <h3 class="nav-title">SYSTEM</h3>
          <ul class="nav-links">
            <li><a href="/about">ABOUT</a></li>
            <li><a href="#" id="toggle-glitch">TOGGLE GLITCH</a></li>
          </ul>
        </div>
      </nav>

      <main class="main-content">
        <section class="crucible-panel crucible-extreme">
          <div class="panel-header">
            <h2>EXTREME GLYPH CRUCIBLE</h2>
            <div class="status-indicator">EXPERIMENTAL</div>
          </div>
          <div class="crucible-content">
            <div class="crucible-controls">
              <div class="form-group">
                <label for="seed">SEED (OPTIONAL):</label>
                <input type="text" id="seed" name="seed" placeholder="Leave empty for random">
              </div>
              <div class="form-group">
                <label for="complexity">COMPLEXITY:</label>
                <select id="complexity" name="complexity">
                  <option value="low">LOW</option>
                  <option value="medium" selected>MEDIUM</option>
                  <option value="high">HIGH</option>
                  <option value="extreme">EXTREME</option>
                </select>
              </div>
              <div class="form-group">
                <label for="render-mode">RENDER MODE:</label>
                <select id="render-mode" name="render-mode">
                  <option value="2d">2D (CLASSIC)</option>
                  <option value="3d" selected>3D (ENHANCED)</option>
                </select>
              </div>
              <button id="generate-glyph">GENERATE SIGIL</button>
            </div>
            
            <div class="generated-glyph-area">
              <div id="generated-glyph-svg" class="generated-glyph-svg" style="display:none;">
                <!-- Generated glyph SVG will be injected here -->
              </div>
              <div id="generated-glyph-3d" class="glyph-3d-container">
                <!-- 3D glyph will be rendered here -->
              </div>
              
              <div id="glyph-options-advanced" class="glyph-options-advanced">
                <h3>ADVANCED CUSTOMIZATION</h3>
                <div class="options-tabs">
                  <div class="option-tab active" data-panel="basic-options">BASIC</div>
                  <div class="option-tab" data-panel="glow-options">GLOW & EFFECTS</div>
                  <div class="option-tab" data-panel="animation-options">ANIMATION</div>
                  <div class="option-tab" data-panel="particle-options">PARTICLES</div>
                  <div class="option-tab" data-panel="aura-options">AURA</div>
                  <div class="option-tab" data-panel="texture-options">TEXTURE</div>
                  <div class="option-tab" data-panel="preset-options">PRESETS</div>
                </div>

                <!-- Basic Options Panel -->
                <div class="options-panel active" id="basic-options">
                  <div class="options-grid">
                    <div class="option-group">
                      <label for="glyph-shape">SIGIL SHAPE:</label>
                      <select id="glyph-shape" name="glyph-shape">
                        <option value="sphere">SPHERE</option>
                        <option value="cube">CUBE</option>
                        <option value="cylinder">CYLINDER</option>
                        <option value="torus">TORUS</option>
                        <option value="tetrahedron">TETRAHEDRON</option>
                        <option value="octahedron">OCTAHEDRON</option>
                        <option value="dodecahedron">DODECAHEDRON</option>
                        <option value="icosahedron">ICOSAHEDRON</option>
                        <option value="torusknot">TORUS KNOT</option>
                        <option value="custom">CUSTOM</option>
                      </select>
                    </div>
                    <div class="option-group">
                      <label for="glyph-color">PRIMARY COLOR:<span class="preview-swatch" id="primary-color-preview"></span></label>
                      <input type="color" id="glyph-color" name="glyph-color" value="#00ff00" class="color-picker">
                    </div>
                    <div class="option-group">
                      <label for="glyph-opacity">OPACITY: <span id="opacity-value" class="slider-value">100%</span></label>
                      <input type="range" id="glyph-opacity" name="glyph-opacity" min="10" max="100" step="5" value="100">
                    </div>
                    <div class="option-group">
                      <label for="glyph-size">SIZE: <span id="size-value" class="slider-value">1.0</span></label>
                      <input type="range" id="glyph-size" name="glyph-size" min="0.5" max="2.0" step="0.1" value="1.0">
                    </div>
                    <div class="option-group">
                      <label for="wireframe-style">WIREFRAME STYLE:</label>
                      <select id="wireframe-style" name="wireframe-style">
                        <option value="none">NONE</option>
                        <option value="lines">LINES</option>
                        <option value="points">POINTS</option>
                        <option value="full">FULL WIREFRAME</option>
                      </select>
                    </div>
                    <div class="option-group">
                      <label for="metalness">METALNESS: <span id="metalness-value" class="slider-value">0.3</span></label>
                      <input type="range" id="metalness" name="metalness" min="0" max="1" step="0.05" value="0.3">
                    </div>
                    <div class="option-group">
                      <label for="roughness">ROUGHNESS: <span id="roughness-value" class="slider-value">0.4</span></label>
                      <input type="range" id="roughness" name="roughness" min="0" max="1" step="0.05" value="0.4">
                    </div>
                    <div class="option-toggle">
                      <input type="checkbox" id="auto-rotate" name="auto-rotate" checked>
                      <label for="auto-rotate">AUTO-ROTATE</label>
                    </div>
                  </div>
                </div>

                <!-- Glow Options Panel -->
                <div class="options-panel" id="glow-options">
                  <div class="options-grid">
                    <div class="option-group">
                      <label for="glow-color">GLOW COLOR:<span class="preview-swatch" id="glow-color-preview"></span></label>
                      <input type="color" id="glow-color" name="glow-color" value="#00ff00" class="color-picker">
                    </div>
                    <div class="option-group">
                      <label for="glow-intensity">GLOW INTENSITY: <span id="glow-intensity-value" class="slider-value">1.5</span></label>
                      <input type="range" id="glow-intensity" name="glow-intensity" min="0" max="5" step="0.1" value="1.5">
                    </div>
                    <div class="option-group">
                      <label for="glow-animation">GLOW ANIMATION:</label>
                      <select id="glow-animation" name="glow-animation">
                        <option value="none">NONE</option>
                        <option value="pulse">PULSE</option>
                        <option value="flicker">FLICKER</option>
                        <option value="blink">BLINK</option>
                        <option value="rainbow">RAINBOW</option>
                        <option value="wave">WAVE</option>
                      </select>
                    </div>
                    <div class="option-group">
                      <label for="glow-speed">GLOW SPEED: <span id="glow-speed-value" class="slider-value">1.0</span></label>
                      <input type="range" id="glow-speed" name="glow-speed" min="0.1" max="3.0" step="0.1" value="1.0">
                    </div>
                    <div class="option-group">
                      <label for="secondary-color">SECONDARY COLOR:<span class="preview-swatch" id="secondary-color-preview"></span></label>
                      <input type="color" id="secondary-color" name="secondary-color" value="#0088ff" class="color-picker">
                    </div>
                    <div class="option-group">
                      <label for="bloom-effect">BLOOM EFFECT:</label>
                      <select id="bloom-effect" name="bloom-effect">
                        <option value="none">NONE</option>
                        <option value="light">LIGHT</option>
                        <option value="medium">MEDIUM</option>
                        <option value="heavy">HEAVY</option>
                      </select>
                    </div>
                    <div class="option-toggle">
                      <input type="checkbox" id="secondary-glow" name="secondary-glow">
                      <label for="secondary-glow">SECONDARY GLOW</label>
                    </div>
                    <div class="option-toggle">
                      <input type="checkbox" id="halo-effect" name="halo-effect">
                      <label for="halo-effect">HALO EFFECT</label>
                    </div>
                  </div>
                </div>
                
                <!-- Animation Options Panel -->
                <div class="options-panel" id="animation-options">
                  <div class="options-grid">
                    <div class="option-group">
                      <label for="rotation-speed">ROTATION SPEED: <span id="rotation-speed-value" class="slider-value">1.0</span></label>
                      <input type="range" id="rotation-speed" name="rotation-speed" min="0" max="5" step="0.1" value="1">
                    </div>
                    <div class="option-group">
                      <label for="animation-style">ANIMATION STYLE:</label>
                      <select id="animation-style" name="animation-style">
                        <option value="rotate">ROTATE</option>
                        <option value="pulse">PULSE</option>
                        <option value="morph">MORPH</option>
                        <option value="orbit">ORBIT</option>
                        <option value="chaos">CHAOS</option>
                        <option value="breathe">BREATHE</option>
                        <option value="spin">SPIN</option>
                      </select>
                    </div>
                    <div class="option-group">
                      <label for="animation-speed">ANIMATION SPEED: <span id="animation-speed-value" class="slider-value">1.0</span></label>
                      <input type="range" id="animation-speed" name="animation-speed" min="0.1" max="3.0" step="0.1" value="1.0">
                    </div>
                    <div class="option-group">
                      <label for="animation-path">ANIMATION PATH:</label>
                      <select id="animation-path" name="animation-path">
                        <option value="none">NONE</option>
                        <option value="circle">CIRCLE</option>
                        <option value="figure8">FIGURE 8</option>
                        <option value="spiral">SPIRAL</option>
                        <option value="zigzag">ZIGZAG</option>
                        <option value="random">RANDOM</option>
                      </select>
                    </div>
                    <div class="option-group">
                      <label for="element-animation">ELEMENT ANIMATION:</label>
                      <select id="element-animation" name="element-animation">
                        <option value="none">NONE</option>
                        <option value="randomize">RANDOMIZE</option>
                        <option value="wave">WAVE</option>
                        <option value="expand">EXPAND</option>
                        <option value="swirl">SWIRL</option>
                      </select>
                    </div>
                    <div class="option-group">
                      <label for="morph-intensity">MORPH INTENSITY: <span id="morph-intensity-value" class="slider-value">0.5</span></label>
                      <input type="range" id="morph-intensity" name="morph-intensity" min="0" max="1" step="0.05" value="0.5">
                    </div>
                    <div class="option-toggle">
                      <input type="checkbox" id="reverse-animation" name="reverse-animation">
                      <label for="reverse-animation">REVERSE DIRECTION</label>
                    </div>
                    <div class="option-toggle">
                      <input type="checkbox" id="alternate-animation" name="alternate-animation">
                      <label for="alternate-animation">ALTERNATE ANIMATION</label>
                    </div>
                  </div>
<!-- Aura Options Panel -->
                <div class="options-panel" id="aura-options">
                  <div class="options-grid">
                    <div class="option-group">
                      <label for="aura-enabled">AURA EFFECT:</label>
                      <select id="aura-enabled" name="aura-enabled">
                        <option value="none">NONE</option>
                        <option value="simple">SIMPLE</option>
                        <option value="double">DOUBLE</option>
                        <option value="pulsating">PULSATING</option>
                        <option value="flame">FLAME</option>
                      </select>
                    </div>
                    <div class="option-group">
                      <label for="aura-color">AURA COLOR:<span class="preview-swatch" id="aura-color-preview"></span></label>
                      <input type="color" id="aura-color" name="aura-color" value="#5500ff" class="color-picker">
                    </div>
                    <div class="option-group">
                      <label for="aura-intensity">AURA INTENSITY: <span id="aura-intensity-value" class="slider-value">1.0</span></label>
                      <input type="range" id="aura-intensity" name="aura-intensity" min="0.1" max="3" step="0.1" value="1.0">
                    </div>
                    <div class="option-group">
                      <label for="aura-size">AURA SIZE: <span id="aura-size-value" class="slider-value">1.5</span></label>
                      <input type="range" id="aura-size" name="aura-size" min="1.1" max="3" step="0.1" value="1.5">
                    </div>
                    <div class="option-group">
                      <label for="aura-pulseRate">PULSE RATE: <span id="aura-pulseRate-value" class="slider-value">1.0</span></label>
                      <input type="range" id="aura-pulseRate" name="aura-pulseRate" min="0.1" max="3" step="0.1" value="1.0">
                    </div>
                    <div class="option-group">
                      <label for="aura-secondary-color">SECONDARY AURA:<span class="preview-swatch" id="aura-secondary-color-preview"></span></label>
                      <input type="color" id="aura-secondary-color" name="aura-secondary-color" value="#ff00aa" class="color-picker">
                    </div>
                    <div class="option-group">
                      <label for="aura-style">AURA STYLE:</label>
                      <select id="aura-style" name="aura-style">
                        <option value="smooth">SMOOTH</option>
                        <option value="electric">ELECTRIC</option>
                        <option value="nebula">NEBULA</option>
                        <option value="fire">FIRE</option>
                        <option value="ice">ICE</option>
                      </select>
                    </div>
                    <div class="option-toggle">
                      <input type="checkbox" id="aura-rotate" name="aura-rotate" checked>
                      <label for="aura-rotate">ROTATING AURA</label>
                    </div>
                  </div>
                </div>

                <!-- Texture Options Panel -->
                <div class="options-panel" id="texture-options">
                  <div class="options-grid">
                    <div class="option-group">
                      <label for="texture-map">TEXTURE TYPE:</label>
                      <select id="texture-map" name="texture-map">
                        <option value="none">NONE</option>
                        <option value="noise">NOISE</option>
                        <option value="circuit">CIRCUIT</option>
                        <option value="grid">GRID</option>
                        <option value="metal">METAL</option>
                        <option value="energy">ENERGY</option>
                        <option value="crystal">CRYSTAL</option>
                        <option value="runes">RUNES</option>
                      </select>
                    </div>
                    <div class="option-group">
                      <label for="texture-scale">TEXTURE SCALE: <span id="texture-scale-value" class="slider-value">1.0</span></label>
                      <input type="range" id="texture-scale" name="texture-scale" min="0.5" max="5" step="0.1" value="1.0">
                    </div>
                    <div class="option-group">
                      <label for="texture-opacity">TEXTURE OPACITY: <span id="texture-opacity-value" class="slider-value">0.8</span></label>
                      <input type="range" id="texture-opacity" name="texture-opacity" min="0.1" max="1" step="0.05" value="0.8">
                    </div>
                    <div class="option-group">
                      <label for="normal-map">NORMAL MAP:</label>
                      <select id="normal-map" name="normal-map">
                        <option value="none">NONE</option>
                        <option value="basic">BASIC</option>
                        <option value="advanced">ADVANCED</option>
                      </select>
                    </div>
                    <div class="option-group">
                      <label for="normal-scale">NORMAL INTENSITY: <span id="normal-scale-value" class="slider-value">1.0</span></label>
                      <input type="range" id="normal-scale" name="normal-scale" min="0" max="2" step="0.1" value="1.0">
                    </div>
                    <div class="option-group">
                      <label for="displacement-map">DISPLACEMENT:</label>
                      <select id="displacement-map" name="displacement-map">
                        <option value="none">NONE</option>
                        <option value="basic">BASIC</option>
                        <option value="advanced">ADVANCED</option>
                      </select>
                    </div>
                    <div class="option-group">
                      <label for="displacement-scale">DISP. INTENSITY: <span id="displacement-scale-value" class="slider-value">0.5</span></label>
                      <input type="range" id="displacement-scale" name="displacement-scale" min="0" max="2" step="0.1" value="0.5">
                    </div>
                    <div class="option-toggle">
                      <input type="checkbox" id="animate-texture" name="animate-texture">
                      <label for="animate-texture">ANIMATE TEXTURE</label>
                    </div>
                  </div>
                </div>

                <!-- Presets Panel -->
                <div class="options-panel" id="preset-options">
                  <h4 style="color: var(--terminal-dim-green); margin-bottom: 0.5rem;">VISUAL PRESETS</h4>
                  <div class="presets-container">
                    <button class="preset-button" data-preset="ethereal">ETHEREAL</button>
                    <button class="preset-button" data-preset="demonic">DEMONIC</button>
                    <button class="preset-button" data-preset="celestial">CELESTIAL</button>
                    <button class="preset-button" data-preset="techno">TECHNO</button>
                    <button class="preset-button" data-preset="void">VOID</button>
                    <button class="preset-button" data-preset="elemental">ELEMENTAL</button>
                    <button class="preset-button" data-preset="ancient">ANCIENT</button>
                    <button class="preset-button" data-preset="radioactive">RADIOACTIVE</button>
                    <button class="preset-button" data-preset="holographic">HOLOGRAPHIC</button>
                    <button class="preset-button" data-preset="arcane">ARCANE</button>
                    <button class="preset-button" data-preset="digital">DIGITAL</button>
                    <button class="preset-button" data-preset="neon">NEON</button>
                  </div>
                  
                  <h4 style="color: var(--terminal-dim-green); margin: 1rem 0 0.5rem;">ANIMATION PRESETS</h4>
                  <div class="presets-container">
                    <button class="preset-button" data-preset="calm">CALM</button>
                    <button class="preset-button" data-preset="frantic">FRANTIC</button>
                    <button class="preset-button" data-preset="hypnotic">HYPNOTIC</button>
                    <button class="preset-button" data-preset="ritual">RITUAL</button>
                    <button class="preset-button" data-preset="pulse">PULSE</button>
<script>
    // Inject data from server
    const data = __DATA__;
    const user = data.user;
    const userGlyphs = data.userGlyphs || [];
    
    // Global variables
    let currentGeneratedGlyph = null;
    let glyph3DRenderer = null;
    let isRendering3D = true;
    let userPresets = JSON.parse(localStorage.getItem('glyph_presets') || '{}');
    
    // Update user status in header
    const userStatusEl = document.getElementById('user-status');
    if (user) {
      userStatusEl.innerHTML = `
        <div class="logged-in">
          <span class="username">${user.username}</span>
          <div class="user-links">
            <a href="/profile">PROFILE</a>
            <a href="/auth/logout">LOGOUT</a>
          </div>
        </div>
      `;
    } else {
      userStatusEl.innerHTML = `
        <div class="logged-out">
          <a href="/auth/login" class="login-btn">LOGIN</a>
          <a href="/auth/register" class="register-btn">REGISTER</a>
        </div>
      `;
    }
    
    // Display user's saved glyphs
    const userGlyphsContentEl = document.getElementById('user-glyphs-content');
    if (userGlyphs && userGlyphs.length > 0) {
      userGlyphs.forEach(glyph => {
        const glyphItem = document.createElement('div');
        glyphItem.className = 'user-glyph-item';
        glyphItem.innerHTML = glyph.svg_data;
        glyphItem.setAttribute('data-glyph-id', glyph.id);
        glyphItem.title = `Generated: ${new Date(glyph.created_at).toLocaleString()}`;
        
        // Add attributes for 3D rendering if available
        if (glyph.glyph_shape) {
          glyphItem.setAttribute('data-shape', glyph.glyph_shape);
          glyphItem.setAttribute('data-color', glyph.glyph_color || '#00ff00');
          glyphItem.setAttribute('data-3d', glyph.glyph_3d_model ? '1' : '0');
        }
        
        // Add click event to view glyph
        glyphItem.addEventListener('click', () => {
          window.location.href = `/glyph/view/${glyph.id}`;
        });
        
        userGlyphsContentEl.appendChild(glyphItem);
      });
    } else {
      userGlyphsContentEl.innerHTML = '<span>NO SAVED SIGILS. GENERATE SOME ABOVE.</span>';
    }
    
    // Tab navigation for advanced options
    document.querySelectorAll('.option-tab').forEach(tab => {
      tab.addEventListener('click', () => {
        // Remove active class from all tabs and panels
        document.querySelectorAll('.option-tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.options-panel').forEach(p => p.classList.remove('active'));
        
        // Add active class to selected tab and panel
        tab.classList.add('active');
        const panelId = tab.getAttribute('data-panel');
        document.getElementById(panelId).classList.add('active');
      });
    });

    // Update slider value displays
    document.querySelectorAll('input[type="range"]').forEach(slider => {
      const valueEl = document.getElementById(slider.id + '-value');
      if (valueEl) {
        // Set initial value
        if (slider.id.includes('opacity')) {
          valueEl.textContent = slider.value + '%';
        } else {
          valueEl.textContent = slider.value;
        }
        
        // Update value on input
        slider.addEventListener('input', () => {
          if (slider.id.includes('opacity')) {
            valueEl.textContent = slider.value + '%';
          } else {
            valueEl.textContent = slider.value;
          }
          updateGlyph3DOptions();
        });
      }
    });

    // Update color preview swatches
    function updateColorSwatches() {
      const colorInputs = document.querySelectorAll('input[type="color"]');
      colorInputs.forEach(input => {
        const previewEl = document.getElementById(input.id + '-preview');
        if (previewEl) {
          previewEl.style.backgroundColor = input.value;
        }
      });
    }

    // Initialize color swatches
    updateColorSwatches();
    
    // Update swatches when color changes
    document.querySelectorAll('input[type="color"]').forEach(input => {
      input.addEventListener('change', () => {
        updateColorSwatches();
        updateGlyph3DOptions();
      });
    });
    
    // Glyph generation functionality
    const generateGlyphBtn = document.getElementById('generate-glyph');
    const seedInput = document.getElementById('seed');
    const complexitySelect = document.getElementById('complexity');
    const renderModeSelect = document.getElementById('render-mode');
    const generatedGlyphSvgEl = document.getElementById('generated-glyph-svg');
    const generatedGlyph3dEl = document.getElementById('generated-glyph-3d');
    const playAudioBtn = document.getElementById('play-audio');
    const saveGlyphBtn = document.getElementById('save-glyph');
    const generationMessageEl = document.getElementById('generation-message');
    const generationErrorEl = document.getElementById('generation-error');
    const glyphOptionsAdvancedEl = document.getElementById('glyph-options-advanced');
    
    // Toggle render mode
    renderModeSelect.addEventListener('change', function() {
      isRendering3D = this.value === '3d';
      
      if (isRendering3D) {
        generatedGlyphSvgEl.style.display = 'none';
        generatedGlyph3dEl.style.display = 'block';
        glyphOptionsAdvancedEl.style.display = 'block';
      } else {
        generatedGlyphSvgEl.style.display = 'flex';
        generatedGlyph3dEl.style.display = 'none';
        glyphOptionsAdvancedEl.style.display = 'none';
        
        // Destroy 3D renderer if it exists
        if (glyph3DRenderer) {
          glyph3DRenderer.destroy();
          glyph3DRenderer = null;
        }
      }
      
      // If we already have a generated glyph, regenerate it with the new mode
      if (currentGeneratedGlyph) {
        const seed = seedInput.value.trim();
        const complexity = complexitySelect.value;
        generateGlyph(seed, complexity);
      }
    });

    // Handler for all option changes
    document.querySelectorAll('select, input').forEach(input => {
      input.addEventListener('change', updateGlyph3DOptions);
      if (input.type === 'range') {
        input.addEventListener('input', updateGlyph3DOptions);
      }
    });

    // Handle preset buttons
    document.querySelectorAll('.preset-button').forEach(button => {
      button.addEventListener('click', () => {
        const presetName = button.getAttribute('data-preset');
        applyPreset(presetName);
      });
    });

    // Save custom preset
    document.getElementById('save-preset-btn').addEventListener('click', () => {
      const presetNameInput = document.getElementById('save-preset-name');
      const presetName = presetNameInput.value.trim();
      
      if (!presetName) {
        generationErrorEl.textContent = 'Please enter a preset name';
        return;
      }
      
      // Save current settings as a preset
      userPresets[presetName] = getCurrentSettings();
      localStorage.setItem('glyph_presets', JSON.stringify(userPresets));
      
      // Create and add a new preset button
      const newPresetBtn = document.createElement('button');
      newPresetBtn.className = 'preset-button';
      newPresetBtn.setAttribute('data-preset', `custom:${presetName}`);
      newPresetBtn.textContent = presetName.toUpperCase();
      newPresetBtn.addEventListener('click', () => {
        applyPreset(`custom:${presetName}`);
      });
      
      document.querySelector('.presets-container').appendChild(newPresetBtn);
      
      // Clear input and show confirmation
      presetNameInput.value = '';
      generationMessageEl.textContent = `Preset "${presetName}" saved successfully`;
      setTimeout(() => { generationMessageEl.textContent = ''; }, 3000);
    });

    // Get current settings for preset saving
    function getCurrentSettings() {
      return {
        shape: document.getElementById('glyph-shape').value,
        color: document.getElementById('glyph-color').value,
        opacity: document.getElementById('glyph-opacity').value,
        size: document.getElementById('glyph-size').value,
        rotationSpeed: document.getElementById('rotation-speed').value,
        autoRotate: document.getElementById('auto-rotate').checked,
        glowColor: document.getElementById('glow-color').value,
        glowIntensity: document.getElementById('glow-intensity').value,
        glowAnimation: document.getElementById('glow-animation').value,
        glowSpeed: document.getElementById('glow-speed').value,
        secondaryColor: document.getElementById('secondary-color').value,
        bloomEffect: document.getElementById('bloom-effect').value,
        secondaryGlow: document.getElementById('secondary-glow').checked,
        haloEffect: document.getElementById('halo-effect').checked,
        animationStyle: document.getElementById('animation-style').value,
        animationSpeed: document.getElementById('animation-speed').value,
        animationPath: document.getElementById('animation-path').value,
        elementAnimation: document.getElementById('element-animation').value,
        morpIntensity: document.getElementById('morph-intensity').value,
        reverseAnimation: document.getElementById('reverse-animation').checked,
        alternateAnimation: document.getElementById('alternate-animation').checked,
        particleEnabled: document.getElementById('particle-enabled').value,
        particleCount: document.getElementById('particle-count').value,
        particleSize: document.getElementById('particle-size').value,
        particleColor: document.getElementById('particle-color').value,
        particleShape: document.getElementById('particle-shape').value,
        particleSpeed: document.getElementById('particle-speed').value,
        particleOpacity: document.getElementById('particle-opacity').value,
        particleBehavior: document.getElementById('particle-behavior').value,
        auraEnabled: document.getElementById('aura-enabled').value,
        auraColor: document.getElementById('aura-color').value,
        auraIntensity: document.getElementById('aura-intensity').value,
        auraSize: document.getElementById('aura-size').value,
        auraSecondaryColor: document.getElementById('aura-secondary-color').value,
        auraStyle: document.getElementById('aura-style').value,
        auraRotate: document.getElementById('aura-rotate').checked,
        textureMap: document.getElementById('texture-map').value,
        textureScale: document.getElementById('texture-scale').value,
        textureOpacity: document.getElementById('texture-opacity').value,
        normalMap: document.getElementById('normal-map').value,
        normalScale: document.getElementById('normal-scale').value,
        displacementMap: document.getElementById('displacement-map').value,
        displacementScale: document.getElementById('displacement-scale').value,
        animateTexture: document.getElementById('animate-texture').checked,
        wireframeStyle: document.getElementById('wireframe-style').value,
        metalness: document.getElementById('metalness').value,
        roughness: document.getElementById('roughness').value
      };
    }

    // Apply visual preset
    function applyPreset(presetName) {
      let presetSettings;
      
      // Check if it's a custom preset
      if (presetName.startsWith('custom:')) {
        const customName = presetName.split(':')[1];
        presetSettings = userPresets[customName];
      } else {
        // Predefined presets
        switch(presetName) {
          case 'ethereal':
            presetSettings = {
              shape: 'sphere',
              color: '#88ffff',
              glowColor: '#00ffff',
              glowIntensity: '2.5',
              glowAnimation: 'pulse',
              glowSpeed: '0.8',
              particleEnabled: 'advanced',
              particleColor: '#ffffff',
              auraEnabled: 'pulsating',
              auraColor: '#00ffff',
              textureMap: 'none',
              animationStyle: 'breathe',
              wireframeStyle: 'lines',
              opacity: '80',
              metalness: '0.1',
              roughness: '0.2'
            };
            break;
            
          case 'demonic':
            presetSettings = {
              shape: 'icosahedron',
              color: '#ff0000',
              glowColor: '#ff0000',
              glowIntensity: '2.0',
              glowAnimation: 'flicker',
              glowSpeed: '1.5',
              particleEnabled: 'advanced',
              particleColor: '#ff5500',
              auraEnabled: 'flame',
              auraColor: '#ff3300',
              textureMap: 'noise',
              animationStyle: 'chaos',
              wireframeStyle: 'full',
              opacity: '90',
              metalness: '0.7',
              roughness: '0.3'
            };
            break;
            
          case 'celestial':
            presetSettings = {
              shape: 'dodecahedron',
              color: '#ffdd00',
              glowColor: '#ffff00',
              glowIntensity: '2.2',
              glowAnimation: 'pulse',
              glowSpeed: '0.5',
              particleEnabled: 'advanced',
              particleColor: '#ffffaa',
              auraEnabled: 'simple',
              auraColor: '#ffff88',
              textureMap: 'none',
              animationStyle: 'rotate',
              wireframeStyle: 'lines',
              opacity: '90',
              metalness: '0.8',
              roughness: '0.1'
            };
            break;
            
          case 'neon':
            presetSettings = {
              shape: 'torus',
              color: '#ff00ff',
              glowColor: '#ff00ff',
              glowIntensity: '3.0',
              glowAnimation: 'rainbow',
              glowSpeed: '1.0',
              particleEnabled: 'advanced',
              particleColor: '#ff77ff',
              auraEnabled: 'double',
              auraColor: '#ff00ff',
              textureMap: 'energy',
              animationStyle: 'spin',
              wireframeStyle: 'lines',
              opacity: '90',
              metalness: '0.5',
              roughness: '0.2'
            };
            break;
            
          // Add other presets as needed
          default:
            // Default preset (if preset name doesn't match)
            presetSettings = {
              shape: 'sphere',
              color: '#00ff00',
              glowColor: '#00ff00',
              glowIntensity: '1.5',
              glowAnimation: 'none',
              glowSpeed: '1.0',
              particleEnabled: 'advanced',
              particleColor: '#00ff88',
              auraEnabled: 'none',
              textureMap: 'none',
              wireframeStyle: 'none'
            };
            break;
        }
      }
      
      // Apply settings to UI controls
      Object.keys(presetSettings).forEach(key => {
        const control = document.getElementById(key) || document.getElementById(`glyph-${key}`);
        if (control) {
          if (control.type === 'checkbox') {
            control.checked = presetSettings[key] === true || presetSettings[key] === 'true';
          } else {
            control.value = presetSettings[key];
          }
          
          // Trigger change event for sliders
          if (control.type === 'range') {
            const event = new Event('input');
            control.dispatchEvent(event);
          }
        }
      });
      
      // Update color swatches
      updateColorSwatches();
      
      // Apply settings to renderer
      updateGlyph3DOptions();
    }

    // Update 3D options when changed
    function updateGlyph3DOptions() {
      if (!glyph3DRenderer) return;
      
      // Get all option values from UI
      const options = {
        shape: document.getElementById('glyph-shape').value,
        color: document.getElementById('glyph-color').value,
        opacity: document.getElementById('glyph-opacity').value / 100,
        size: parseFloat(document.getElementById('glyph-size').value),
        rotationSpeed: parseFloat(document.getElementById('rotation-speed').value) * 0.01,
        autoRotate: document.getElementById('auto-rotate').checked,
        glowColor: document.getElementById('glow-color').value,
        glowIntensity: parseFloat(document.getElementById('glow-intensity').value),
        glowAnimation: document.getElementById('glow-animation').value,
        glowSpeed: parseFloat(document.getElementById('glow-speed').value),
        secondaryColor: document.getElementById('secondary-color').value,
        bloomEffect: document.getElementById('bloom-effect').value,
        secondaryGlow: document.getElementById('secondary-glow').checked,
        haloEffect: document.getElementById('halo-effect').checked,
        wireframeStyle: document.getElementById('wireframe-style').value,
        metalness: parseFloat(document.getElementById('metalness').value),
        roughness: parseFloat(document.getElementById('roughness').value),
        animationStyle: document.getElementById('animation-style').value,
        animationSpeed: parseFloat(document.getElementById('animation-speed').value),
        animationPath: document.getElementById('animation-path').value,
        elementAnimation: document.getElementById('element-animation').value,
        morpIntensity: parseFloat(document.getElementById('morph-intensity').value),
        reverseAnimation: document.getElementById('reverse-animation').checked,
        alternateAnimation: document.getElementById('alternate-animation').checked,
        particleEnabled: document.getElementById('particle-enabled').value,
        particleCount: parseInt(document.getElementById('particle-count').value),
        particleSize: parseFloat(document.getElementById('particle-size').value),
        particleColor: document.getElementById('particle-color').value,
        particleShape: document.getElementById('particle-shape').value,
        particleSpeed: parseFloat(document.getElementById('particle-speed').value),
        particleOpacity: parseFloat(document.getElementById('particle-opacity').value),
        particleBehavior: document.getElementById('particle-behavior').value,
        auraEnabled: document.getElementById('aura-enabled').value,
        auraColor: document.getElementById('aura-color').value,
        auraIntensity: parseFloat(document.getElementById('aura-intensity').value),
        auraSize: parseFloat(document.getElementById('aura-size').value),
        auraPulseRate: parseFloat(document.getElementById('aura-pulseRate').value),
        auraSecondaryColor: document.getElementById('aura-secondary-color').value,
        auraStyle: document.getElementById('aura-style').value,
        auraRotate: document.getElementById('aura-rotate').checked,
        textureMap: document.getElementById('texture-map').value,
        textureScale: parseFloat(document.getElementById('texture-scale').value),
        textureOpacity: parseFloat(document.getElementById('texture-opacity').value),
        normalMap: document.getElementById('normal-map').value,
        normalScale: parseFloat(document.getElementById('normal-scale').value),
        displacementMap: document.getElementById('displacement-map').value,
        displacementScale: parseFloat(document.getElementById('displacement-scale').value),
        animateTexture: document.getElementById('animate-texture').checked
      };
      
      // Update the renderer with new options
      glyph3DRenderer.updateOptions(options);
      
      // Update currentGeneratedGlyph data
      if (currentGeneratedGlyph) {
        currentGeneratedGlyph.glyphShape = options.shape;
        currentGeneratedGlyph.glyphColor = options.color;
        // Add other properties as needed
      }
    }
    
    // Generate glyph
    generateGlyphBtn.addEventListener('click', function() {
      const seed = seedInput.value.trim();
      const complexity = complexitySelect.value;
      generateGlyph(seed, complexity);
    });
    
    // Function to generate glyph based on mode
    async function generateGlyph(seed, complexity) {
      generationMessageEl.textContent = '';
      generationErrorEl.textContent = '';
      
      // Clear previous glyph
      generatedGlyphSvgEl.innerHTML = '<span>GENERATING...</span>';
      
      if (glyph3DRenderer) {
        glyph3DRenderer.destroy();
        glyph3DRenderer = null;
      }
      
      playAudioBtn.style.display = 'none';
      saveGlyphBtn.style.display = 'none';
      currentGeneratedGlyph = null;
      
      try {
        const response = await fetch('/glyph/generate', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ seed, complexity })
        });
        
        const data = await response.json();
        
        if (data.success) {
          currentGeneratedGlyph = data.glyph;
          
          // Add 3D specific properties
          currentGeneratedGlyph.glyphShape = document.getElementById('glyph-shape').value;
          currentGeneratedGlyph.glyphColor = document.getElementById('glyph-color').value;
          
          // Handle 2D rendering
          generatedGlyphSvgEl.innerHTML = currentGeneratedGlyph.svgData;
          
          // Handle 3D rendering if enabled
          if (isRendering3D) {
            // Create 3D renderer with enhanced options
            const options = {
              seed: currentGeneratedGlyph.seed,
              complexity: complexity,
              shape: document.getElementById('glyph-shape').value,
              color: document.getElementById('glyph-color').value,
              rotationSpeed: parseFloat(document.getElementById('rotation-speed').value) * 0.01,
              autoRotate: document.getElementById('auto-rotate').checked,
              opacity: document.getElementById('glyph-opacity').value / 100,
              size: parseFloat(document.getElementById('glyph-size').value),
              glowColor: document.getElementById('glow-color').value,
              glowIntensity: parseFloat(document.getElementById('glow-intensity').value),
              glowAnimation: document.getElementById('glow-animation').value,
              glowSpeed: parseFloat(document.getElementById('glow-speed').value),
              // Add other options
              wireframeStyle: document.getElementById('wireframe-style').value,
              metalness: parseFloat(document.getElementById('metalness').value),
              roughness: parseFloat(document.getElementById('roughness').value),
              animationStyle: document.getElementById('animation-style').value,
              particleEnabled: document.getElementById('particle-enabled').value,
              auraEnabled: document.getElementById('aura-enabled').value,
              textureMap: document.getElementById('texture-map').value
            };
            
            // Load the Glyph3DRenderer dynamically
            if (typeof Glyph3DRenderer !== 'undefined') {
              glyph3DRenderer = new Glyph3DRenderer('generated-glyph-3d', options);
            } else {
              // Load script if not available
              const script = document.createElement('script');
              script.src = '/js/glyph3d.js';
              script.onload = () => {
                glyph3DRenderer = new Glyph3DRenderer('generated-glyph-3d', options);
              };
              document.head.appendChild(script);
            }
          }
          
          playAudioBtn.style.display = 'inline-block';
          
          // Only show save button if logged in
          if (user) {
            saveGlyphBtn.style.display = 'inline-block';
          }
          
          generationMessageEl.textContent = 'SIGIL GENERATED.';
        } else {
          generatedGlyphSvgEl.innerHTML = '<span>GENERATION FAILED</span>';
          generationErrorEl.textContent = data.message || 'Glyph generation failed. Unknown error.';
        }
      } catch (error) {
        console.error('Glyph generation error:', error);
        generatedGlyphSvgEl.innerHTML = '<span>GENERATION FAILED</span>';
        generationErrorEl.textContent = 'System error. Could not connect to crucible.';
      }
    }
    
    // Play glyph audio (placeholder)
    playAudioBtn.addEventListener('click', () => {
      if (currentGeneratedGlyph && currentGeneratedGlyph.audioData) {
        try {
          const audioParams = JSON.parse(currentGeneratedGlyph.audioData);
          console.log('Playing audio with parameters:', audioParams);
          // In a real implementation, you would use the Web Audio API here
          generationMessageEl.textContent = 'PLAYING AUDIO (SIMULATED)...';
          setTimeout(() => {
            generationMessageEl.textContent = 'AUDIO PLAYBACK COMPLETE.';
          }, 2000);
        } catch (e) {
          console.error('Error parsing audio data:', e);
          generationErrorEl.textContent = 'Error playing audio. Corrupted data.';
        }
      }
    });
    
    // Save glyph
    saveGlyphBtn.addEventListener('click', async () => {
      if (!currentGeneratedGlyph) return;
      
      generationMessageEl.textContent = '';
      generationErrorEl.textContent = '';
      
      // Prepare data to save with all customization options
      const saveData = {
        svgData: currentGeneratedGlyph.svgData,
        audioData: currentGeneratedGlyph.audioData,
        seed: currentGeneratedGlyph.seed,
        glyphShape: document.getElementById('glyph-shape').value,
        glyphColor: document.getElementById('glyph-color').value,
        glyph3d: isRendering3D ? 1 : 0,
        // Add enhanced properties
        glyphOpacity: document.getElementById('glyph-opacity').value,
        glyphSize: document.getElementById('glyph-size').value,
        glowColor: document.getElementById('glow-color').value,
        glowIntensity: document.getElementById('glow-intensity').value,
        glowAnimation: document.getElementById('glow-animation').value,
        // Add custom presets and options as JSON data
        customOptions: JSON.stringify(getCurrentSettings())
      };
      
      try {
        const response = await fetch('/glyph/save', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(saveData)
        });
        
        const data = await response.json();
        
        if (data.success) {
          generationMessageEl.textContent = data.message;
          // Reload saved glyphs
          setTimeout(() => {
            window.location.reload();
          }, 1000);
        } else {
          generationErrorEl.textContent = data.message || 'Glyph save failed. Unknown error.';
        }
      } catch (error) {
        console.error('Glyph save error:', error);
        generationErrorEl.textContent = 'System error. Could not save glyph.';
      }
    });
    
    // Toggle glitch effects
    document.getElementById('toggle-glitch').addEventListener('click', function(e) {
      e.preventDefault();
      document.body.classList.toggle('glitch-active');
    });

    // Initialize color swatches on page load
    document.addEventListener('DOMContentLoaded', function() {
      updateColorSwatches();
    });
  </script>
</body>
</html>
                    <button class="preset-button" data-preset="static">STATIC</button>
                    <button class="preset-button" data-preset="quantum">QUANTUM</button>
                    <button class="preset-button" data-preset="flowing">FLOWING</button>
                  </div>
                  
                  <div class="option-group" style="margin-top: 1rem;">
                    <label for="save-preset-name">SAVE CURRENT AS PRESET:</label>
                    <div style="display: flex;">
                      <input type="text" id="save-preset-name" placeholder="PRESET NAME" style="flex: 1; margin-right: 0.5rem;">
                      <button id="save-preset-btn" style="background: rgba(0,100,0,0.3); border: 1px solid var(--terminal-dim-green); padding: 0.5rem; color: var(--terminal-dim-green);">SAVE</button>
                    </div>
                  </div>
                </div>
              </div>
              
              <div class="glyph-actions">
                <button id="play-audio" style="display: none;">PLAY AUDIO</button>
                <button id="save-glyph" style="display: none;">SAVE SIGIL</button>
                <div id="generation-message" style="color: var(--terminal-green); margin-top: 1rem;"></div>
                <div id="generation-error" style="color: var(--terminal-red); margin-top: 1rem;"></div>
              </div>
            </div>
          </div>
        </section>

        <section class="user-glyphs-panel">
          <div class="panel-header">
            <h2>YOUR SAVED SIGILS</h2>
            <div class="status-indicator">ARCHIVE</div>
          </div>
          <div class="user-glyphs-content" id="user-glyphs-content">
            <!-- User's saved glyphs will be injected here -->
          </div>
        </section>
      </main>
    </div>

    <footer class="main-footer">
      <div class="footer-text">ELRIEL NETWORK // ESTABLISHED 2025 // ALL RIGHTS SURRENDERED</div>
      <div class="footer-glyphs">
        <span class="glyph"></span>
        <span class="glyph"></span>
        <span class="glyph"></span>
      </div>
    </footer>
  </div>
                </div>

                <!-- Particle Options Panel -->
                <div class="options-panel" id="particle-options">
                  <div class="options-grid">
                    <div class="option-group">
                      <label for="particle-enabled">PARTICLE SYSTEM:</label>
                      <select id="particle-enabled" name="particle-enabled">
                        <option value="off">OFF</option>
                        <option value="basic">BASIC</option>
                        <option value="advanced" selected>ADVANCED</option>
                      </select>
                    </div>
                    <div class="option-group">
                      <label for="particle-count">PARTICLE COUNT: <span id="particle-count-value" class="slider-value">50</span></label>
                      <input type="range" id="particle-count" name="particle-count" min="0" max="500" step="10" value="50">
                    </div>
                    <div class="option-group">
                      <label for="particle-size">PARTICLE SIZE: <span id="particle-size-value" class="slider-value">0.05</span></label>
                      <input type="range" id="particle-size" name="particle-size" min="0.01" max="0.2" step="0.01" value="0.05">
                    </div>
                    <div class="option-group">
                      <label for="particle-color">PARTICLE COLOR:<span class="preview-swatch" id="particle-color-preview"></span></label>
                      <input type="color" id="particle-color" name="particle-color" value="#00ff88" class="color-picker">
                    </div>
                    <div class="option-group">
                      <label for="particle-shape">PARTICLE SHAPE:</label>
                      <select id="particle-shape" name="particle-shape">
                        <option value="point">POINT</option>
                        <option value="sphere">SPHERE</option>
                        <option value="star">STAR</option>
                        <option value="cube">CUBE</option>
                        <option value="custom">CUSTOM</option>
                      </select>
                    </div>
                    <div class="option-group">
                      <label for="particle-speed">PARTICLE SPEED: <span id="particle-speed-value" class="slider-value">1.0</span></label>
                      <input type="range" id="particle-speed" name="particle-speed" min="0.1" max="3" step="0.1" value="1.0">
                    </div>
                    <div class="option-group">
                      <label for="particle-opacity">PARTICLE OPACITY: <span id="particle-opacity-value" class="slider-value">0.7</span></label>
                      <input type="range" id="particle-opacity" name="particle-opacity" min="0.1" max="1" step="0.05" value="0.7">
                    </div>
                    <div class="option-group">
                      <label for="particle-behavior">PARTICLE BEHAVIOR:</label>
                      <select id="particle-behavior" name="particle-behavior">
                        <option value="orbit">ORBIT</option>
                        <option value="float">FLOAT</option>
                        <option value="swarm">SWARM</option>
                        <option value="explode">EXPLODE</option>
                        <option value="rain">RAIN</option>
                        <option value="vortex">VORTEX</option>
                      </select>
                    </div>
                  </div>
                </div>